<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Difficulty Annotator (Pilot)</title>
    <style>
        /* Basic Setup */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }

        /* --- MODAL STYLES (NEW) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .modal-content h2 { margin-top: 0; color: #007bff; }
        .example-box {
            background: #f1f3f5;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .good-ex { color: #2e7d32; font-weight: bold; }
        .bad-ex { color: #c62828; font-weight: bold; }
        .btn-start {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 10px;
        }
        /* -------------------------- */

        /* Layout */
        .top-bar, .bottom-bar {
            background: #fff;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .bottom-bar {
            border-top: 1px solid #ddd;
            border-bottom: none;
            text-align: right;
        }

        .layout {
            display: flex;
            padding: 20px;
            gap: 20px;
            min-height: 70vh;
        }

        .text-panel {
            flex: 2;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }
        .sidebar-right {
            flex: 1;
            min-width: 320px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .text-panel p {
            font-size: 1.1rem;
            color: #222;
        }
        
        /* Highlight Styles */
        .text-panel p::selection { background-color: #fdd835; }
        .temp-highlight {
            background-color: #fdd835;
            border-bottom: 2px solid #fbc02d;
            cursor: pointer;
        }
        
        /* Sentence Selection */
        .sentence-container { display: inline; position: relative; }
        .select-sentence-btn {
            display: inline-block;
            width: 18px; height: 18px;
            background-color: #e0e0e0; color: #555;
            border: none; border-radius: 50%;
            padding: 0; margin: 0 5px 0 0;
            cursor: pointer;
            font-size: 10px; line-height: 18px; text-align: center; font-weight: bold;
            opacity: 0.3; transition: all 0.2s;
        }
        .text-panel p:hover .select-sentence-btn { opacity: 0.6; }
        .select-sentence-btn:hover { opacity: 1; background-color: #007bff; color: white; transform: scale(1.1); }
        .sentence.is-selected { background-color: #fdd835; }


        /* Sidebar Components */
        #current-selection, #difficulty-list, #final-feedback {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        #current-selection { display: none; }
        #current-selection.is-active { display: block; }
        #final-feedback { display: none; }
        #final-feedback.is-active { display: block; }
        #current-selection h3, #difficulty-list h3, #final-feedback h3 {
            margin-top: 0;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        /* Form Elements */
        label.question-label {
            display: block; font-weight: bold;
            margin-top: 15px; margin-bottom: 5px;
        }
        textarea {
            width: 95%; min-height: 80px;
            border: 1px solid #ccc; border-radius: 4px; padding: 8px;
            font-family: inherit;
        }
        .form-option {
            display: flex; align-items: center; gap: 8px; margin-bottom: 5px;
        }
        .form-option label { font-weight: normal; margin: 0; cursor: pointer; }

        /* Quiz Specific Styles */
        .quiz-block {
            background-color: #f8f9fa; border: 1px solid #e9ecef;
            padding: 15px; border-radius: 6px; margin-bottom: 20px;
        }
        .quiz-question-text { font-weight: bold; margin-bottom: 10px; display: block; }
        .quiz-meta-q {
            margin-top: 10px; padding-top: 10px;
            border-top: 1px dashed #ccc; font-size: 0.9em; color: #555;
        }

        /* Buttons */
        button {
            display: inline-block; background-color: #007bff; color: white;
            border: none; padding: 10px 15px; border-radius: 5px;
            cursor: pointer; font-size: 0.9rem; font-weight: bold;
            margin-right: 10px; margin-top: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        
        .difficulty-item {
            border: 1px solid #eee; border-radius: 5px;
            padding: 10px; margin-bottom: 10px; background: #fafafa;
        }
        .difficulty-item blockquote {
            margin: 5px 0 10px 0; padding-left: 10px;
            border-left: 3px solid #fdd835; font-style: italic;
        }
    </style>
</head>
<body>

    <div id="instruction-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Help Us Improve Medical Information</h2>
            
            <p style="font-size: 1.1em; color: #2c3e50;">
                <strong>The Scenario:</strong> Imagine you are reading this text to find important medical information for yourself or a family member.
            </p>

            <p><strong>Your Task:</strong> Read naturally. If you get stuck, <strong>highlight</strong> the specific part that blocks your understanding.</p>
            
            <ul>
                <li>Is there a word you don't know that <strong>stops you from understanding the sentence</strong>?</li>
                <li>Is a sentence so long or complex that you had to <strong>read it twice</strong>?</li>
                <li>Is there a gap where you <strong>don't see how two sentences connect</strong>?</li>
                <li>Do you understand the words, but not <strong>why it matters</strong> (e.g., is this result good or bad)?</li>
            </ul>

            <div class="example-box">
                <p style="margin-top:0"><strong>How to explain your difficulty:</strong></p>
                <p>For each highlight, briefly explain the issue or ask a <strong>clarifying question</strong>.</p>
                
                <p><span class="bad-ex">Too Vague:</span> "Confusing." / "Hard."</p>
                <p><span class="good-ex">Good:</span> "I don't know what 'prophylaxis' means."</p>
                <p><span class="good-ex">Good:</span> "How does this conclusion connect to the previous sentence?"</p>
                <p><span class="good-ex">Good:</span> "This sentence is too dense; I lost track of the meaning."</p>
            </div>

            <div style="background-color: #e8f6f3; padding: 10px; border-left: 4px solid #1abc9c; margin: 15px 0; font-size: 0.9em;">
                <strong><span style="font-size:1.2em">üìù</span> Note:</strong> 
                There will be <strong>2 brief questions</strong> about the text content at the end. 
                Please read carefully enough to answer them!
            </div>

            <button class="btn-start" id="btn-close-modal">I understand, Start Task</button>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px; max-width: 550px;
            font-family: sans-serif; line-height: 1.5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .example-box {
            background-color: #f9f9f9; border: 1px solid #ddd;
            padding: 15px; border-radius: 4px; margin: 15px 0;
        }
        .bad-ex { color: #c0392b; font-weight: bold; }
        .good-ex { color: #27ae60; font-weight: bold; }
        .btn-start {
            background-color: #2980b9; color: white; border: none; padding: 12px 20px;
            font-size: 1rem; border-radius: 4px; cursor: pointer; width: 100%;
            margin-top: 10px;
        }
        .btn-start:hover { background-color: #2471a3; }
    </style>
    <!-- ------------------------- -->

    <div class="top-bar">
        <div class="container">
            <h2>üè• Help Improve Medical Clarity</h2>
            
            <div class="task-steps">
                <span class="step completed">
                    <span class="step-num">1.</span> 
                    Highlight barriers to understanding
                </span>
                <span class="divider">‚Üí</span>
                <span class="step">
                    <span class="step-num">2.</span> 
                    Brief comprehension check
                </span>
            </div>
        </div>
    </div>
    
    <div class="layout">
    
      <div class="text-panel" id="text-panel">
        <!-- Text injected here -->
      </div>
    
      <div class="sidebar-right">
        
        <!-- --- ANNOTATION FORM --- -->
        <div id="current-selection">
          <h3>Annotate Selection</h3>
          <p>Selected: <strong id="selected-text-display"></strong></p>
          <button type="button" class="secondary" id="btn-clear">Cancel</button>

          <form id="difficulty-form">
            <div>
              <label class="question-label" for="difficulty-description">Why was this difficult?</label>
              <!-- Updated Placeholder -->
              <textarea id="difficulty-description" name="difficulty-description" placeholder="E.g., 'Unknown word', 'Sentence too complex', 'Logic gap'. Please be specific."></textarea>
              <div style="margin-top:10px;">
                <button type="button" id="btn-save">Save Annotation</button>
              </div>
            </div>
          </form>
        </div>

        <!-- --- COMPREHENSION & FEEDBACK FORM --- -->
        <div id="final-feedback">
          <h3>Comprehension Check</h3>
          <button type="button" class="secondary" id="btn-go-back">Go Back to Text</button>

          <form id="final-form">
            <!-- Dynamic Quiz Questions will be injected here -->
            <div id="quiz-container"></div>

            <hr style="margin: 25px 0; border: 0; border-top: 2px solid #eee;">
            
            <h3>Overall Feedback</h3>
            
            <label class="question-label">Q1. How familiar were you with this topic before reading?</label>
            <div class="form-option"><input type="radio" id="fam-1" name="familiarity" value="1"><label for="fam-1">1 - Not at all familiar</label></div>
            <div class="form-option"><input type="radio" id="fam-2" name="familiarity" value="2"><label for="fam-2">2 - Slightly familiar</label></div>
            <div class="form-option"><input type="radio" id="fam-3" name="familiarity" value="3"><label for="fam-3">3 - Somewhat familiar</label></div>
            <div class="form-option"><input type="radio" id="fam-4" name="familiarity" value="4"><label for="fam-4">4 - Very familiar</label></div>
            <div class="form-option"><input type="radio" id="fam-5" name="familiarity" value="5"><label for="fam-5">5 - Extremely familiar</label></div>

            <label class="question-label" style="margin-top: 20px;">Q2. Overall, how difficult was this text to read?</label>
            <div class="form-option"><input type="radio" id="diff-1" name="difficulty" value="1"><label for="diff-1">1 - Very Easy</label></div>
            <div class="form-option"><input type="radio" id="diff-2" name="difficulty" value="2"><label for="diff-2">2 - Easy</label></div>
            <div class="form-option"><input type="radio" id="diff-3" name="difficulty" value="3"><label for="diff-3">3 - Moderate</label></div>
            <div class="form-option"><input type="radio" id="diff-4" name="difficulty" value="4"><label for="diff-4">4 - Difficult</label></div>
            <div class="form-option"><input type="radio" id="diff-5" name="difficulty" value="5"><label for="diff-5">5 - Very Difficult</label></div>

            <label class="question-label" style="margin-top: 20px;">Q3. How confident are you that you understood the main points of the text?</label>
            <div class="form-option"><input type="radio" id="conf-1" name="confidence" value="1"><label for="conf-1">1 - Not confident at all</label></div>
            <div class="form-option"><input type="radio" id="conf-2" name="confidence" value="2"><label for="conf-2">2 - Slightly unconfident</label></div>
            <div class="form-option"><input type="radio" id="conf-3" name="confidence" value="3"><label for="conf-3">3 - Somewhat confident</label></div>
            <div class="form-option"><input type="radio" id="conf-4" name="confidence" value="4"><label for="conf-4">4 - Confident</label></div>
            <div class="form-option"><input type="radio" id="conf-5" name="confidence" value="5"><label for="conf-5">5 - Very Confident</label></div>

            <div class="final-comments">
                <label class="question-label" style="margin-top: 20px;">
                    Q4. If you could improve this text, what are the <strong>TOP 3</strong> changes that would help the most?
                    <!-- <span style="font-weight:normal; font-size: 0.9em; color: #e67e22;">(Please select exactly 1 or 2 options)</span> -->
                </label>
                
                <div class="checkbox-group" id="wishlist-group">
                    <label class="checkbox-option">
                        <input type="checkbox" name="improvement" value="simpler_vocab">
                        <span><strong>Use everyday words</strong> (Swap hard words for simple ones)</span>
                    </label>

                    <label class="checkbox-option">
                        <input type="checkbox" name="improvement" value="definitions">
                        <span><strong>Define the terms</strong> (Keep the terms, but explain what they mean)</span>
                    </label>

                    <label class="checkbox-option">
                        <input type="checkbox" name="improvement" value="shorter_sentences">
                        <span><strong>Shorten sentences</strong> (Break long sentences into chunks)</span>
                    </label>

                    <label class="checkbox-option">
                        <input type="checkbox" name="improvement" value="better_flow">
                        <span><strong>Connect the ideas</strong> (Make it clearer how one point leads to the next)</span>
                    </label>

                    <label class="checkbox-option">
                        <input type="checkbox" name="improvement" value="reorder">
                        <span><strong>Group related info</strong> (The order of information is confusing)</span>
                    </label>

                    <label class="checkbox-option">
                        <input type="checkbox" name="improvement" value="significance">
                        <span><strong>Explain the impact</strong> (Tell me if this is good/bad news)</span>
                    </label>
                </div>
                <div id="limit-warning" style="color: #c0392b; font-size: 0.9em; display: none; margin-top:5px;">
                    You can only select 3 priorities. Please uncheck one to select another.
                </div>
            </div>
            <style>
                /* .improvement-section {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 6px;
                    border: 1px solid #e9ecef;
                    margin-top: 20px;
                } */
                .checkbox-group {
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    margin-top: 10px;
                }
                .checkbox-option {
                    display: flex;
                    align-items: center; /* Aligns box and text vertically */
                    gap: 10px;
                    cursor: pointer;
                    font-size: 0.95em;
                    color: #34495e;
                }
                .checkbox-option input[type="checkbox"] {
                    transform: scale(1.2); /* Makes checkboxes easier to click */
                    cursor: pointer;
                }
                #input-other {
                    border: none;
                    border-bottom: 1px solid #ccc;
                    background: transparent;
                    padding: 2px 5px;
                    flex-grow: 1;
                    outline: none;
                }
                #input-other:focus { border-bottom: 2px solid #3498db; }
            </style>

            <script>
                // Simple logic to enforce the "Pick 3" limit
                const checks = document.querySelectorAll('input[name="improvement"]');
                const max = 3;

                checks.forEach(check => {
                    check.addEventListener('change', function() {
                        const checkedCount = document.querySelectorAll('input[name="improvement"]:checked').length;
                        
                        if (checkedCount > max) {
                            this.checked = false; // Undo the check
                            document.getElementById('limit-warning').style.display = 'block';
                            setTimeout(() => document.getElementById('limit-warning').style.display = 'none', 3000);
                        }
                    });
                });
            </script>

            <button type="button" id="btn-submit-final" style="margin-top: 20px; width: 100%;">Submit All Data</button>
          </form>
        </div>
    
        <!-- --- LIST OF SAVED ITEMS --- -->
        <div id="difficulty-list">
          <h3>Your Annotations</h3>
          <div id="list-container"></div>
        </div>
      </div>
    </div>
    
    <div class="bottom-bar">
      <button id="btn-show-final-feedback">Next: Comprehension Questions</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const googleScriptURL = "https://script.google.com/macros/s/AKfycbxX0mApv27ibm21yZdUrkAMpQTb-rFwSLtw5ZjmxxsIA8BrwMgTMld5cvXo7krZz_UZPA/exec";
        
        // --- TEXT DATA ---
        const studyTexts = {
            "text_01": "This chapter covers antidepressants that fall into the class of serotonin (5-HT) and norepinephrine (NE) reuptake inhibitors. That is, they bind to the 5-HT and NE transporters with varying levels of potency and binding affinity ratios. Duloxetine is a more potent 5-HT and NE reuptake inhibitor with a more balanced profile of binding at about 10:1 for 5HT and NE transporter binding. It is also a moderate inhibitor of CYP2D6, so that modest dose reductions and careful monitoring will be needed when prescribing duloxetine in combination with drugs that are preferentially metabolized by CYP2D6. The most common side effects identified in clinical trials are nausea, dry mouth, dizziness, constipation, insomnia, asthenia, and hypertension, consistent with its mechanisms of action. Clinical trials to date have demonstrated rates of response and remission in patients with major depression that are comparable to other marketed antidepressants reviewed in this book. In addition to approval for MDD, duloxetine is approved for diabetic peripheral neuropathic pain, fibromyalgia, and musculoskeletal pain. All medications in the class can cause serotonin syndrome when combined with MAOIs.",
            
            "text_02": "Asthma is the most common chronic disease of childhood and, in the latter part of the 20th century, reached epidemic proportions. Asthma is generally believed to result from gene-environment interactions. There is consensus that a 'window of opportunity' exists during pregnancy and early in life when environmental factors may influence its development. We review multiple environmental, biologic and sociologic factors that may be important in the development of asthma. Meta-analyses of studies have demonstrated that multifaceted interventions are required in order to develop asthma prevention. Multifaceted allergen reduction studies have shown clinical benefits. Asthma represents a dysfunctional interaction with our genes and the environment to which they are exposed, especially in fetal and early infant life. The increasing prevalence of asthma also may be an indication of increased population risk for the development of other chronic non-communicable autoimmune diseases. This review will focus on the factors which may be important in the primary prevention of asthma. Better understanding of the complex gene-environment interactions involved in the development of asthma will provide insight into personalized interventions for asthma prevention.",
            
            "text_03": "In patients with advanced-stage chronic kidney disease (CKD), progressive kidney function decline leads to increased risk for hyperkalemia (serum potassium > 5.0 or >5.5 mEq\/L). Medications such as renin-angiotensin-aldosterone system inhibitors pose an additional hyperkalemia risk, especially in patients with CKD. When hyperkalemia develops, clinicians often recommend a diet that is lower in potassium content. This review discusses the barriers to adherence to a low-potassium diet and the impact of dietary restrictions on adverse clinical outcomes. Accumulating evidence indicates that a diet that incorporates potassium-rich foods has multiple health benefits, which may also be attributable to the other vitamin, mineral, and fiber content of potassium-rich foods. These benefits include blood pressure reductions and reduced risks for cardiovascular disease and stroke. High-potassium foods may also prevent CKD progression and reduce mortality risk in patients with CKD. Adjunctive treatment with the newer potassium-binding agents, patiromer and sodium zirconium cyclosilicate, may allow for optimal renin-angiotensin-aldosterone system inhibitor therapy in patients with CKD and hyperkalemia, potentially making it possible for patients with CKD and hyperkalemia to liberalize their diet. This may allow them the health benefits of a high-potassium diet without the increased risk for hyperkalemia, although further studies are needed.",

            "text_04": "As COVID-19 continues to spread rapidly worldwide and variants continue to emerge, the development and deployment of safe and effective vaccines are urgently needed. Here, we developed an mRNA vaccine based on the trimeric receptor-binding domain (RBD) of the SARS-CoV-2 spike (S) protein fused to ferritin-formed nanoparticles (TF-RBD). Compared to the trimeric form of the RBD mRNA vaccine (T-RBD), TF-RBD delivered intramuscularly elicited robust and durable humoral immunity as well as a Th1-biased cellular response. After further challenge with live SARS-CoV-2, immunization with a two-shot low-dose regimen of TF-RBD provided adequate protection in hACE2-transduced mice. In addition, the mRNA template of TF-RBD was easily and quickly engineered into a variant vaccine to address SARS-CoV-2 mutations. The TF-RBD multivalent vaccine produced broad-spectrum neutralizing antibodies against Alpha (B.1.1.7) and Beta (B.1.351) variants. This mRNA vaccine based on the encoded self-assembled nanoparticle-based trimer RBD provides a reference for the design of mRNA vaccines targeting SARS-CoV-2.",

            "text_05": "The comparative absorption of zinc after oral administration of three different complexed forms was studied in 15 healthy human volunteers in a double-blind four-period crossover trial. The individuals were randomly divided into four groups. Each group rotated for four week periods through a random sequence of oral supplementation including: zinc picolinate, zinc citrate, and zinc gluconate (equivalent to 50 mg elemental zinc per day) and placebo. Zinc was measured in hair, urine, erythrocyte and serum before and after each period. At the end of four weeks hair, urine and erythrocyte zinc levels rose significantly (p less than 0.005, p less than 0.001, and p less than 0.001) during zinc picolinate administration. There was no significant change in any of these parameters from zinc gluconate, zinc citrate or placebo administration. There was a small, insignificant rise in serum zinc during zinc picolinate, zinc citrate and placebo supplementation. The results of this study suggest that zinc absorption in humans can be improved by complexing zinc with picolinic acid."
        };

        // --- QUIZ DATA ---
        const studyQuizzes = {
            "text_01": [
                {
                    "id": "t1_q1",
                    "question": "Why is extra caution needed when combining duloxetine with certain other medications?",
                    "options": [
                        "Because duloxetine makes other drugs work faster than usual",
                        "Because duloxetine can slow the breakdown of certain drugs, causing their levels to rise",
                        "Because duloxetine causes immediate allergic reactions when taken with most medications",
                        "Because duloxetine blocks all drug absorption in the stomach"
                    ]
                }, // Correct answer: B
                {
                    "id": "t1_q2",
                    "question": "Which of the following best summarizes why duloxetine is widely used or approved?",
                    "options": [
                        "It treats multiple conditions and works about as well as other antidepressants",
                        "It has no side effects and works better than all antidepressants",
                        "It is only approved for major depression but is less effective than most alternatives",
                        "It treats only pain conditions and is not used for depression"
                    ]
                } // Correct answer: A
            ],
            "text_02": [
                {
                    "id": "t2_q1",
                    "question": "According to the passage, what might the increasing prevalence of asthma suggest?",
                    "options": [
                        "That asthma directly causes autoimmune diseases",
                        "That more people are at risk for developing other chronic non-communicable autoimmune diseases",
                        "That autoimmune diseases are decreasing in the population",
                        "That asthma is unrelated to broader population health trends"
                    ]
                }, // Correct answer: B
                {
                    "id": "t2_q2",
                    "question": "Which statement best summarizes the overall message of the passage?",
                    "options": [
                        "Asthma is caused solely by genetics and cannot be prevented",
                        "Asthma rates are decreasing, and single-factor interventions are usually enough for prevention",
                        "Asthma develops from complex gene-environment interactions, and effective prevention requires multifaceted approaches",
                        "Asthma is fully understood, and personalized prevention strategies are already widely available"
                    ]
                } // Correct answer: C
            ],
            "text_03": [
                {
                    "id": "t3_q1",
                    "question": "Why does potassium intake create a challenge for patients with advanced chronic kidney disease (CKD)?",
                    "options": [
                        "Many potassium-rich foods have important health benefits, but their kidneys cannot remove excess potassium effectively.",
                        "Potassium-rich foods are more expensive than low-potassium foods",
                        "CKD patients need extremely high potassium intake for their heart to function",
                        "Potassium has no effect on CKD, so it is not medically relevant"
                    ]
                },  // Correct answer: A
                {
                    "id": "t3_q2",
                    "question": "What is a key practical takeaway for patients with CKD who struggle to follow a low-potassium diet?",
                    "options": [
                        "They must permanently avoid all high-potassium foods to stay healthy",
                        "New potassium-binding medications may allow some patients to safely include more potassium-rich foods in their diet, but medical supervision is still needed",
                        "High-potassium foods are harmless for all CKD patients",
                        "Diet has no meaningful effect on potassium levels in CKD patients"
                    ]
                } // Correct answer: B
            ],
            "text_04": [
                {
                    "id": "t4_q1",
                    "question": "According to the passage, what was one key advantage of the TF-RBD mRNA vaccine compared to the trimeric RBD mRNA vaccine (T-RBD)?",
                    "options": [
                        "TF-RBD produced weaker immune responses to reduce side effects",
                        "TF-RBD elicited stronger and longer-lasting immune responses, including a Th1-biased cellular response",
                        "TF-RBD required more doses to achieve protection",
                        "TF-RBD could only protect against the original SARS-CoV-2 strain"
                    ]
                }, // Correct answer: B
                {
                    "id": "t4_q2",
                    "question": "What is a practical implication of developing the TF-RBD mRNA vaccine platform?",
                    "options": [
                        "It shows that vaccines no longer need to be updated when new variants appear",
                        "It demonstrates that mRNA vaccine designs can be quickly adapted to target new SARS-CoV-2 variants",
                        "It replaces all existing COVID-19 vaccines currently in use",
                        "It proves that nanoparticle-based vaccines cannot induce protective immunity"
                    ]
                } // Correct answer: B
            ],
            "text_05": [
                {
                    "id": "t5_q1",
                    "question": "According to the study results, which form of zinc led to a significant increase in zinc levels in hair, urine, and erythrocytes?",
                    "options": [
                        "Zinc gluconate",
                        "Zinc citrate",
                        "Zinc picolinate",
                        "Placebo"
                    ]
                }, // Correct answer: C
                {
                    "id": "t5_q2",
                    "question": "What is the main practical implication of this study for someone choosing a zinc supplement?",
                    "options": [
                        "All forms of zinc supplements increase zinc levels equally",
                        "Zinc picolinate may be absorbed better by the body compared to zinc citrate or zinc gluconate",
                        "Zinc supplements should never be taken unless prescribed",
                        "Zinc citrate is the only form that significantly increases serum zinc"
                    ]
                } // Correct answer: B
            ]
        };
            
        // ---------------------

        document.addEventListener('DOMContentLoaded', () => {
            // --- MODAL LOGIC ---
            const modal = document.getElementById('instruction-modal');
            const btnCloseModal = document.getElementById('btn-close-modal');
            
            // Allow user to close modal and start
            btnCloseModal.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            // -------------------

            let savedAnnotations = []; 
            
            const urlParams = new URLSearchParams(window.location.search);
            const workerID = urlParams.get('PROLIFIC_PID') || "TEST_USER";
            const stimulusID = urlParams.get('stimulus') || "text_01";
            const completionCode = urlParams.get('cc') || "TEST_CODE";
            const prolificCompletionURL = "https://app.prolific.com/submissions/complete?cc=" + completionCode;

            const textPanel = document.getElementById('text-panel');
            const currentSelectionPanel = document.getElementById('current-selection');
            const selectedTextDisplay = document.getElementById('selected-text-display');
            const difficultyForm = document.getElementById('difficulty-form');
            const difficultyDescription = document.getElementById('difficulty-description');
            const saveButton = document.getElementById('btn-save');
            const clearButton = document.getElementById('btn-clear');
            const listContainer = document.getElementById('list-container');
            const difficultyListPanel = document.getElementById('difficulty-list');
            
            const finalFeedbackPanel = document.getElementById('final-feedback');
            const quizContainer = document.getElementById('quiz-container');
            const showFinalFeedbackButton = document.getElementById('btn-show-final-feedback');
            const submitFinalButton = document.getElementById('btn-submit-final');
            const goBackButton = document.getElementById('btn-go-back');

            let activeSelectedText = ""; 
            // NEW: Store precise location
            let activeStartIndex = -1;
            let activeEndIndex = -1;
            
            let activeSentenceSpan = null; 
            let activeHighlightSpan = null; 

            // 1. INIT TEXT
            const prepareText = () => {
                const rawText = studyTexts[stimulusID] || "Error: Text not found.";
                textPanel.innerHTML = `<p>${rawText}</p>`;
                
                const paragraphs = textPanel.querySelectorAll('p');
                const sentenceRegex = /.*?[.!?](?=\s|$)/g;
                paragraphs.forEach(p => {
                    const originalText = p.textContent;
                    const sentences = originalText.match(sentenceRegex);
                    if (sentences) {
                        p.innerHTML = ''; 
                        sentences.forEach(sentenceText => {
                            const container = document.createElement('span');
                            container.className = 'sentence-container';
                            
                            const button = document.createElement('button');
                            button.className = 'select-sentence-btn';
                            button.textContent = 'S'; 
                            
                            const sentenceSpan = document.createElement('span');
                            sentenceSpan.className = 'sentence';
                            sentenceSpan.textContent = sentenceText;
                            
                            button.addEventListener('click', () => {
                                clearSelection(true); 
                                sentenceSpan.classList.add('is-selected');
                                activeSentenceSpan = sentenceSpan;
                                showSelectionForm(sentenceText.trim());
                            });
                            
                            container.appendChild(button);
                            container.appendChild(sentenceSpan);
                            p.appendChild(container);
                            p.appendChild(document.createTextNode(' ')); 
                        });
                    }
                });
            };
            
            // --- NEW HELPER: Calculates offsets ignoring 'S' buttons ---
            const getCleanSelectionOffsets = (container, range) => {
                // 1. Measure text coming BEFORE the selection
                const preSelectionRange = range.cloneRange();
                preSelectionRange.selectNodeContents(container);
                preSelectionRange.setEnd(range.startContainer, range.startOffset);

                const div = document.createElement('div');
                div.appendChild(preSelectionRange.cloneContents());
                // Remove buttons from the measurement
                div.querySelectorAll('.select-sentence-btn').forEach(el => el.remove());
                const start = div.textContent.length;
                
                // 2. Measure the selected text itself
                const contentDiv = document.createElement('div');
                contentDiv.appendChild(range.cloneContents());
                contentDiv.querySelectorAll('.select-sentence-btn').forEach(el => el.remove());
                const cleanText = contentDiv.textContent;
                
                return { start, end: start + cleanText.length, text: cleanText };
            };

            // 2. SELECTION LOGIC
            const showSelectionForm = (selectedText) => {
                if (selectedText.length > 0) {
                    activeSelectedText = selectedText;
                    selectedTextDisplay.textContent = selectedText.length > 50 ? selectedText.substring(0, 50) + "..." : selectedText;
                    currentSelectionPanel.classList.add('is-active');
                    difficultyListPanel.style.display = 'none'; 
                    setTimeout(() => difficultyDescription.focus(), 100);
                }
            };

            textPanel.addEventListener('mouseup', () => {
                // 1. Safety checks
                if (finalFeedbackPanel.classList.contains('is-active')) return;
                
                const selection = document.getSelection();

                // Ensure user actually selected a range inside the panel
                if (selection.rangeCount > 0 && !selection.isCollapsed && textPanel.contains(selection.anchorNode)) {
                    
                    const range = selection.getRangeAt(0);

                    // 2. NEW: Calculate the clean offsets and text
                    // This ignores the "S" buttons so indices are accurate
                    const result = getCleanSelectionOffsets(textPanel, range);
                    const selectedText = result.text.trim();

                    if (selectedText.length > 0) {
                        // 3. NEW: Save these numbers to your global variables 
                        // (Make sure you defined activeStartIndex/activeEndIndex at the top of your script!)
                        activeStartIndex = result.start;
                        activeEndIndex = result.end;
                        activeSelectedText = selectedText;

                        // --- Existing Visual Logic Starts Here ---
                        if (activeSentenceSpan) {
                            activeSentenceSpan.classList.remove('is-selected');
                            activeSentenceSpan = null;
                        }
                        if (activeHighlightSpan) {
                            removeHighlight();
                        }

                        try {
                            const span = document.createElement('span');
                            span.className = 'temp-highlight';
                            range.surroundContents(span);
                            activeHighlightSpan = span;
                            selection.removeAllRanges();
                        } catch (e) {
                            console.log("Selection crosses boundaries, visual highlight skipped.");
                        }
                        // --- Existing Visual Logic Ends Here ---

                        showSelectionForm(selectedText);
                    }
                }
            });
            
            const removeHighlight = () => {
                if (activeHighlightSpan) {
                    const parent = activeHighlightSpan.parentNode;
                    while (activeHighlightSpan.firstChild) {
                        parent.insertBefore(activeHighlightSpan.firstChild, activeHighlightSpan);
                    }
                    parent.removeChild(activeHighlightSpan);
                    activeHighlightSpan = null;
                }
            };

            const clearSelection = (keepForm = false) => {
                document.getSelection().removeAllRanges(); 
                if (activeSentenceSpan) {
                    activeSentenceSpan.classList.remove('is-selected');
                    activeSentenceSpan = null;
                }
                removeHighlight();
                
                if (!keepForm) {
                    currentSelectionPanel.classList.remove('is-active'); 
                    difficultyForm.reset(); 
                    activeSelectedText = "";
                    difficultyListPanel.style.display = 'block'; 
                }
            };
            clearButton.addEventListener('click', () => clearSelection(false));

            // 3. SAVE ANNOTATION
            saveButton.addEventListener('click', () => {
                if (!activeSelectedText) return; 
                const description = difficultyDescription.value.trim();
                if (!description) {
                    alert("Please write a brief description.");
                    return;
                }

                const annotation = {
                    text: activeSelectedText,
                    start_index: activeStartIndex, // NEW field
                    end_index: activeEndIndex,     // NEW field
                    reasons: description
                };
                savedAnnotations.push(annotation);

                const newItem = document.createElement('div');
                newItem.className = 'difficulty-item';
                newItem.innerHTML = `<blockquote>${activeSelectedText.substring(0,100)}...</blockquote><p>${description}</p>`;

                // --- add delete button for this annotation ---
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'secondary';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    // remove from data
                    savedAnnotations = savedAnnotations.filter(a => a !== annotation);
                    // remove from UI
                    listContainer.removeChild(newItem);
                });
                // append the button to the annotation item
                newItem.appendChild(deleteBtn);
                // --------------------------------------------

                listContainer.appendChild(newItem);

                clearSelection(false);
            });

            // 4. QUIZ GENERATION
            const renderQuiz = () => {
                quizContainer.innerHTML = '';
                const questions = studyQuizzes[stimulusID] || [];
                
                if (questions.length === 0) {
                    quizContainer.innerHTML = '<p>No questions for this text.</p>';
                    return;
                }

                questions.forEach((q, index) => {
                    const block = document.createElement('div');
                    block.className = 'quiz-block';
                    
                    let html = `<label class="quiz-question-text">Q${index + 1}. ${q.question}</label>`;
                    
                    q.options.forEach(opt => {
                        html += `
                        <div class="form-option">
                            <input type="radio" name="${q.id}_ans" value="${opt}">
                            <label>${opt}</label>
                        </div>`;
                    });

                    html += `
                    <div class="quiz-meta-q">
                        <label style="font-weight:bold; font-size:0.9em;">How difficult was this question to answer?</label>
                        <div style="display:flex; justify-content:space-between; font-size: 0.8em; margin-top:5px;">
                            <span>Easy</span>
                            <span>Hard</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <input type="radio" name="${q.id}_diff" value="1">
                            <input type="radio" name="${q.id}_diff" value="2">
                            <input type="radio" name="${q.id}_diff" value="3">
                            <input type="radio" name="${q.id}_diff" value="4">
                            <input type="radio" name="${q.id}_diff" value="5">
                        </div>
                    </div>`;

                    block.innerHTML = html;
                    quizContainer.appendChild(block);
                });
            };

            // 5. NAVIGATION FLOW
            showFinalFeedbackButton.addEventListener('click', () => {
                clearSelection(false); 
                currentSelectionPanel.style.display = 'none'; 
                difficultyListPanel.style.display = 'none'; 
                finalFeedbackPanel.classList.add('is-active');
                showFinalFeedbackButton.style.display = 'none';
                
                textPanel.querySelectorAll('.select-sentence-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.1';
                    btn.style.cursor = 'default';
                });

                renderQuiz();
                document.querySelector('.sidebar-right').scrollTop = 0;
            });

            goBackButton.addEventListener('click', () => {
                finalFeedbackPanel.classList.remove('is-active');
                
                // --- FIX: Clear the inline styles set by the 'Next' button ---
                currentSelectionPanel.style.display = ''; 
                // -------------------------------------------------------------

                difficultyListPanel.style.display = 'block';
                showFinalFeedbackButton.style.display = 'inline-block';
                
                textPanel.querySelectorAll('.select-sentence-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.cursor = 'pointer';
                });
            });

            // 6. SUBMISSION
            submitFinalButton.addEventListener('click', () => {
                const finalForm = document.getElementById('final-form');
                const formData = new FormData(finalForm);

                // --- NEW LOGIC: Collect Checkbox Data ---
                const wishlist = [];
                // Select all checkboxes with name="improvement" that are currently checked
                const checkedBoxes = document.querySelectorAll('input[name="improvement"]:checked');

                checkedBoxes.forEach(box => {
                    if (box.value === 'other') {
                        // If they checked "Other", grab the text from the text input
                        const otherText = document.getElementById('input-other').value.trim();
                        // Save it as "Other: [what they typed]"
                        wishlist.push(`Other: ${otherText || "Unspecified"}`);
                    } else {
                        // Otherwise just push the value (e.g., "simpler_vocab")
                        wishlist.push(box.value);
                    }
                });
                // ----------------------------------------

                const quizAnswers = [];
                const questions = studyQuizzes[stimulusID] || [];
                questions.forEach(q => {
                    quizAnswers.push({
                        question_id: q.id,
                        answer: formData.get(`${q.id}_ans`) || "No Answer",
                        difficulty_rating: formData.get(`${q.id}_diff`) || "N/A"
                    });
                });

                const payload = {
                    worker_id: workerID,
                    stimulus_id: stimulusID,
                    familiarity: formData.get('familiarity') || 'N/A',
                    overall_difficulty: formData.get('difficulty') || 'N/A',
                    
                    // UPDATE: Send the array joined as a string (easier for Google Sheets)
                    // Output example: "simpler_vocab, definitions, Other: Make font bigger"
                    final_comments: wishlist.join(', ') || 'None', 
                    
                    annotations: savedAnnotations,
                    quiz_results: quizAnswers
                };
                
                // UI Feedback
                submitFinalButton.disabled = true;
                submitFinalButton.textContent = "Submitting...";

                fetch(googleScriptURL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    finalFeedbackPanel.innerHTML = '<h3>Thank you!</h3><p>Redirecting you to Prolific...</p>';
                    setTimeout(() => window.location.href = prolificCompletionURL, 1500);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Submission error. Please check your connection.");
                    submitFinalButton.disabled = false;
                    submitFinalButton.textContent = "Submit All Data";
                });
            });
            prepareText();
        });
    </script>
</body>
</html>