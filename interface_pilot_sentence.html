<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Difficulty Annotator (Spotlight)</title>
    <style>
        /* Basic Setup */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
            overflow-y: hidden; /* Prevent body scroll, handle in layout */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px;
            max-width: 850px; width: 85%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 1.1rem;
            line-height: 1.5;
        }
        .modal-content h2 { margin: 6px 0 10px; color: #007bff; font-size: 1.5rem; }
        .modal-content h3 { margin: 8px 0 6px; font-size: 1.2rem; }
        .modal-content p { margin: 10px 0; }
        .modal-content li { margin: 4px 0; }
        .modal-content ul { margin-top: 2px; margin-bottom: 8px; }
        .modal-content ol { margin-top: 4px; margin-bottom: 10px; padding-left: 18px; }
        .instruction-block {
            margin: 12px 0;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #f9fafb;
        }
        .example-box {
            background: #f1f3f5; padding: 15px; border-radius: 5px;
            margin: 15px 0; border-left: 4px solid #007bff;
        }
        .good-ex { color: #2e7d32; font-weight: bold; }
        .bad-ex { color: #c62828; font-weight: bold; }
        .btn-start {
            background-color: #007bff; color: white; padding: 12px 24px;
            font-size: 1.1rem; width: 100%; margin-top: 10px; cursor: pointer; border:none; border-radius:4px;
        }

        /* --- MULTI-PAGE MODAL UPDATES --- */
        .instr-step {
            display: none; /* Hide all steps by default */
            animation: fadeIn 0.3s;
        }
        .instr-step.active {
            display: block; /* Show only the active step */
        }

        .modal-nav-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .btn-modal-nav {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn-modal-back {
            background: #f1f3f5;
            color: #555;
        }
        .btn-modal-next {
            background: #007bff;
            color: white;
        }
        .btn-modal-next:hover { background: #0056b3; }

        /* Simple fade animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Progress Dots */
        .step-indicators {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .step-dot {
            width: 10px;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .step-dot.active {
            background-color: #007bff;
            transform: scale(1.2);
        }

        /* Layout */
        .top-bar {
            background: #fff; padding: 10px 20px;
            border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .layout {
            display: flex;
            flex: 1; /* Fill remaining height */
            padding: 20px;
            gap: 20px;
            overflow: hidden; /* Contain scrolls */
        }

        .text-panel {
            flex: 2;
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-y: auto;
            font-size: 1.25rem;
            line-height: 2;
            color: #222;
        }
        
        .sidebar-right {
            flex: 1;
            min-width: 350px;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* Button */
        .btn-help {
            background: transparent;
            border: 1px solid #ccc;
            color: #555;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-help:hover {
            background: #f1f1f1;
            border-color: #bbb;
            color: #333;
        }

        /* --- SPOTLIGHT STYLES (NEW) --- */
        .sentence {
            transition: all 0.3s ease;
            padding: 2px 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .sentence.dimmed {
            opacity: 0.3;
            filter: blur(0px); /* Optional blur */
        }
        .sentence.active {
            opacity: 1;
            background-color: #fff9c4; /* Soft yellow highlight */
            box-shadow: 0 0 0 3px #fbc02d; /* Solid border/glow */
            font-weight: 500;
        }

        /* --- CONTROLS --- */
        .control-card {
            background: #fff; padding: 20px;
            border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .control-card h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* Likert Scale */
        .likert-scale { display: flex; gap: 5px; margin-bottom: 20px; }
        .likert-btn {
            flex: 1; padding: 10px 5px; text-align: center;
            border: 1px solid #ddd; border-radius: 4px;
            cursor: pointer; background: #fff; transition: all 0.2s;
            font-weight: bold; color: #555;
        }
        .likert-btn:hover { background: #f8f9fa; border-color: #bbb; }
        .likert-btn.selected {
            background-color: #007bff; color: white; border-color: #007bff;
            transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .likert-label { display: block; font-size: 0.75rem; font-weight: normal; margin-top: 4px; }

        /* Diagnosis Form */
        #diagnosis-section { display: block; margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px; }
        .checkbox-option { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer; }
        .checkbox-option input { transform: scale(1.2); }
        
        #vocab-input-container, #other-input-container { margin-left: 25px; display: none; margin-bottom: 10px; }
        #vocab-input, #other-input { width: 90%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }

        /* Navigation Buttons */
        .nav-bar { display: flex; gap: 10px; margin-top: 20px; }
        .btn-nav {
            flex: 1; padding: 12px; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; font-size: 1rem;
        }
        .btn-prev { background-color: #e2e6ea; color: #333; }
        .btn-next { background-color: #007bff; color: white; opacity: 0.5; pointer-events: none; }
        .btn-next.active { opacity: 1; pointer-events: auto; }
        .btn-next:hover { background-color: #0056b3; }
        .btn-nav:disabled,
        .btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quiz Panel */
        #final-feedback { display: none; }
        #final-feedback.active { display: block; }
        .quiz-block { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #eee; }
        .question-label { font-weight: bold; display: block; margin-bottom: 10px; }
        .form-option { margin-bottom: 5px; }
        .quiz-meta-q {
            margin-top: 10px; padding-top: 10px;
            border-top: 1px dashed #ccc; font-size: 0.9em; color: #555;
        }

        /* Improvements Checkboxes */
        .checkbox-group {
            display: flex; flex-direction: column; gap: 12px; margin-top: 10px;
        }

    </style>
</head>
<body>

    <!-- Instructions Modal -->
    <div id="instruction-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="instr-step active">
                <h2>üëã Thank you for participating!</h2>
                <p>In this study, you will read a scientific abstract about <span id="instruction-topic">{topic}</span>.</p>

                <div class="instruction-block">
                    <h3 style="margin-top:0;">What you will do</h3>
                    <p>Imagine you're reading this text to find important medical information for yourself or a family member.</p>
                    <ol>
                        <li>
                            <strong>Rate each sentence</strong><br>
                            <ul style="margin-top:4px; margin-bottom:4px;">
                                <li><strong>Ease of Reading</strong> ‚Äî how easy the sentence was to read.</li>
                                <li><strong>Confidence in Understanding</strong> ‚Äî how confident you are about what this sentence means and how it fits with what you‚Äôve read so far.</li>
                            </ul>
                        </li>

                        <li>
                            <strong>Give your overall impressions</strong><br>
                            After rating all sentences, you will answer a few questions about the text as a whole.
                        </li>

                        <li>
                            <strong>Complete a short comprehension quiz</strong><br>
                            Finally, you will answer <strong>several questions</strong> to check your understanding of the content.
                        </li>
                    </ol>
                </div>
                <p><strong>Your responses will help us understand which parts of medical writing are easy or difficult for everyday readers, so we can help improve communication for patients and families.</strong></p>
            </div>

            <div class="instr-step">
                <h3>How to use the rating scales</h3>

                <div style="background-color:#f7f9fc; padding:12px; border-left:4px solid #3498db; margin:18px 0; font-size:0.9em;">
                    <p style="margin:0 0 6px 0;"><strong>Ease of Reading (1‚Äì5)</strong></p>
                    <ul style="margin:0 0 8px 18px; padding:0;">
                        <li><strong>1 ‚Äì Very hard to read:</strong> You needed to slow down or reread a lot.</li>
                        <li><strong>5 ‚Äì Very easy to read:</strong> Smooth to read; no pauses or rereading.</li>
                    </ul>

                    <p style="margin:8px 0 2px 0;"><strong>Confidence in Understanding (1‚Äì5)</strong></p>
                    <ul style="margin:0 0 0 18px; padding:0;">
                        <li><strong>1 ‚Äì Not confident:</strong> You did not understand what it means in context and couldn‚Äôt explain it.</li>
                        <li><strong>5 ‚Äì Very confident:</strong> You‚Äôre certain what it means in context and could explain it in your own words.</li>
                    </ul>
                </div>
            </div>

            <div class="step-indicators" id="step-indicators"></div>

            <div class="modal-nav-bar" style="margin-top: 16px;">
                <button class="btn-modal-nav btn-modal-back" id="modal-btn-back">Back</button>
                <div style="flex-grow:1"></div>
                <button class="btn-modal-nav btn-modal-next" id="modal-btn-next">Next</button>
            </div>

        </div> <!-- modal-content -->
    </div> <!-- modal-overlay -->


    <!-- Top Header -->
    <div class="top-bar" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin:0; font-size: 1.2rem;">üè• Medical Clarity Study</h2>
        <button id="btn-show-help" class="btn-help">‚ùìInstructions</button>
    </div>
    
    <!-- Main Layout -->
    <div class="layout">
    
        <!-- Text Panel (Left) -->
        <div class="text-panel" id="text-panel">
            <!-- Sentences injected here -->
        </div>
    
        <!-- Sidebar (Right) -->
        <div class="sidebar-right">
            
            <!-- --- SPOTLIGHT CONTROLS --- -->
            <div class="control-card" id="spotlight-controls">
                <h3>
                    Step 1. Sentence Analysis
                    <span style="font-size:0.8rem; float:right; color:#777; margin-top:4px;">
                        <span id="progress-indicator">1</span> / <span id="total-sentences">0</span>
                    </span>
                </h3>

                <p class="question-label" style="margin-bottom:6px;">1. While reading, how easy was this sentence to read?</p>
                
                <div class="likert-scale" id="likert-effort">
                    <div class="likert-btn" data-val="1">1<span class="likert-label">Very hard</span></div>
                    <div class="likert-btn" data-val="2">2<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="3">3<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="4">4<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="5">5<span class="likert-label">Very easy</span></div>
                </div>

                <p class="question-label" style="margin:12px 0 6px;">How confident are you that you understood what this sentence means in this context?</p>
                <div class="likert-scale" id="likert-confidence">
                    <div class="likert-btn" data-val="1">1<span class="likert-label">Not Confident</span></div>
                    <div class="likert-btn" data-val="2">2<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="3">3<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="4">4<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="5">5<span class="likert-label">Very confident</span></div>
                </div>

                <div id="diagnosis-section" class="feedback-box" style="margin-top:12px; padding:10px; border:1px solid #eee; border-radius:6px; background:#f9fafb;">
                    <p class="question-label" style="margin:0 0 8px 0;">
                      Did anything make this sentence harder to read, follow, or understand?
                    </p>
                                    
                    <!-- PASTE NEW BLOCK STARTS HERE -->
                    <div id="issue-section" style="margin-top:12px; padding-top:12px; border-top:1px dashed #ddd;">
                      <p class="question-label" style="margin:0 0 8px 0;">
                        Issues (required): choose ‚ÄúNo issue‚Äù OR select one or more issues.
                      </p>
                  
                      <label class="checkbox-option">
                        <input type="checkbox" id="issue-none" />
                        <span><strong>No issue</strong></span>
                      </label>
                  
                      <div id="issue-list" style="margin-top: 8px;">
                        <label class="checkbox-option">
                          <input type="checkbox" class="issue-checkbox" value="unclear_term" />
                          <span>Unclear term / jargon / abbreviation</span>
                        </label>
                  
                        <label class="checkbox-option">
                          <input type="checkbox" class="issue-checkbox" value="too_dense" />
                          <span>Too dense / hard to read</span>
                        </label>
                  
                        <label class="checkbox-option">
                          <input type="checkbox" class="issue-checkbox" value="awkward_wordy_vague" />
                          <span>Awkward / wordy / vague phrasing</span>
                        </label>
                  
                        <label class="checkbox-option">
                          <input type="checkbox" class="issue-checkbox" value="unclear_takeaway" />
                          <span>Unclear implication / takeaway</span>
                        </label>
                  
                        <label class="checkbox-option">
                          <input type="checkbox" class="issue-checkbox" value="unclear_reference" />
                          <span>Unclear reference / link to previous sentences</span>
                        </label>
                  
                        <label class="checkbox-option">
                          <input type="checkbox" class="issue-checkbox" value="other" id="issue-other" />
                          <span>Other (optional comment)</span>
                        </label>
                  
                        <div id="other-input-container">
                          <input id="other-input" type="text" placeholder="Describe what felt confusing, or ask any questions." />
                        </div>
                      </div>
                    </div>
                    <!-- PASTE NEW BLOCK ENDS HERE -->
                </div>                  

                <div class="nav-bar">
                    <button class="btn-nav btn-prev" id="btn-prev">Previous</button>
                    <button class="btn-nav btn-next" id="btn-next">Next</button>
                </div>
            </div>

            <!-- --- QUIZ PANEL (Initially Hidden) --- -->
            <div class="control-card" id="final-feedback">
                <form id="final-form">
                    <div id="overall-section">
                        <h3>Step 2. Overall Feedback</h3>
            
                        <label class="question-label">Q1. How much effort did it take to read this text?</label>
                        <div class="likert-scale" id="overall-eff">
                            <div class="likert-btn" data-group="overall_effort" data-val="1">1<span class="likert-label">No effort</span></div>
                            <div class="likert-btn" data-group="overall_effort" data-val="2">2<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_effort" data-val="3">3<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_effort" data-val="4">4<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_effort" data-val="5">5<span class="likert-label">Very high effort</span></div>
                        </div>

                        <label class="question-label" style="margin-top: 20px;">Q2. How well do you think you understood the main points of the text?</label>
                        <div class="likert-scale" id="overall-conf">
                            <div class="likert-btn" data-group="overall_confidence" data-val="1">1<span class="likert-label">Not at all</span></div>
                            <div class="likert-btn" data-group="overall_confidence" data-val="2">2<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_confidence" data-val="3">3<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_confidence" data-val="4">4<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_confidence" data-val="5">5<span class="likert-label">Completely</span></div>
                        </div>

                        <div class="final-comments">
                            <label class="question-label" style="margin-top: 20px;">
                                Q3. If you could improve this text, what are the changes that would help the most (select at most 3)?
                            </label>
                            
                            <div class="checkbox-group" id="wishlist-group">
                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="simpler_vocab">
                                    <span><strong>Use everyday words</strong> (Swap hard words for simple ones)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="definitions">
                                    <span><strong>Define the terms</strong> (Keep the terms, but explain what they mean)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="shorter_sentences">
                                    <span><strong>Shorten sentences</strong> (Break long sentences into chunks)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="better_flow">
                                    <span><strong>Connect the ideas</strong> (Make it clearer how one point leads to the next)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="reorder">
                                    <span><strong>Group related info</strong> (The order of information is confusing)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="significance">
                                    <span><strong>Explain the impact</strong> (Tell me if this is good/bad news)</span>
                                </label>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <h4 style="margin:0 0 8px 0; font-size:1.5rem;">Tell us a bit about yourself!</h4>
                            <label class="question-label">Q4. How much of the information in this abstract was new to you?</label>
                            <div class="likert-scale" id="overall-fam">
                                <div class="likert-btn" data-group="overall_fam" data-val="1">1<span class="likert-label">None</span></div>
                                <div class="likert-btn" data-group="overall_fam" data-val="2">2<span class="likert-label">A little</span></div>
                                <div class="likert-btn" data-group="overall_fam" data-val="3">3<span class="likert-label">Some</span></div>
                                <div class="likert-btn" data-group="overall_fam" data-val="4">4<span class="likert-label">Most</span></div>
                                <div class="likert-btn" data-group="overall_fam" data-val="5">5<span class="likert-label">Almost all</span></div>
                            </div>

                            <label class="question-label" style="margin-top: 16px;">Q5. Which of the following types of texts do you read or encounter in your daily life? (Check all that apply)</label>
                            <div class="checkbox-group" id="overall-exposure">
                                <label class="checkbox-option">
                                    <input type="checkbox" name="exposure" value="General news or magazine articles">
                                    <span>General news or magazine articles</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" name="exposure" value="In-depth nonfiction or detailed articles">
                                    <span>In-depth nonfiction or detailed articles</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" name="exposure" value="Professional or technical documents">
                                    <span>Professional or technical documents</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" name="exposure" value="Academic or research articles">
                                    <span>Academic or research articles</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" name="exposure" value="None of the above" id="exposure-none">
                                    <span>None of the above</span>
                                </label>
                            </div>
                        </div>

                        <button type="button" class="btn-start" id="btn-start-quiz" style="margin-top:20px;" disabled>Begin Quiz</button>
                    </div>

            <div id="quiz-container" style="margin-top:20px; display:none;"></div>

            <div id="quiz-complete-message" style="display:none; margin-top:15px; font-weight:bold; color:#2e7d32;">
                Quiz complete. You can submit your responses now.
            </div>

                    <div id="quiz-summary" style="display:none; margin-top:20px; padding:15px; border-radius:8px; background:#eef7ff; border:1px solid #cfe2ff;">
                        <h3 style="margin-top:0;">Answer Key</h3>
                        <p style="margin:8px 0 12px;">Below are the correct answers for each quiz question. Thank you for taking the time to participate!</p>
                        <div id="quiz-summary-list" style="display:flex; flex-direction:column; gap:10px;"></div>
                    </div>

                    <button type="button" class="btn-start" id="btn-submit-final" style="margin-top:20px; display:none;">Submit All Data</button>
                </form>
            </div>

        </div>
    </div>

    <script src="studyConfig.js"></script>
    <script src="studyDataNew.js"></script>
    <script>
        // --- CONFIG ---
        const submissionURL = (typeof googleScriptURL === 'string' && googleScriptURL.trim().length > 0)
            ? googleScriptURL
            : "https://script.google.com/macros/s/AKfycbwefYLFqc-MUxps38IuE6pQAxOIQtg3x-ytywkMhfbISoQLBwmQRBbMPCKZSFWd7YhrOQ/exec";
        // --- STATE ---
        let sentences = [];
        let currentIndex = 0;
        // Map: index -> { rating, confidence, feedbackText, entireHard }
        let annotations = {};

        // --- DOM ---
        const textPanel = document.getElementById('text-panel');
        const spotlightControls = document.getElementById('spotlight-controls');
        const finalFeedback = document.getElementById('final-feedback');
        const progressIndicator = document.getElementById('progress-indicator');
        const totalSentencesSpan = document.getElementById('total-sentences');
        const quizContainer = document.getElementById('quiz-container');
        const quizCompleteMessage = document.getElementById('quiz-complete-message');
        const quizSummary = document.getElementById('quiz-summary');
        const quizSummaryList = document.getElementById('quiz-summary-list');
        const overallSection = document.getElementById('overall-section');
        const startQuizBtn = document.getElementById('btn-start-quiz');
        const modalOverlay = document.getElementById('instruction-modal');
        const modalNext = document.getElementById('modal-btn-next');
        
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const effortButtons = document.querySelectorAll('#likert-effort .likert-btn');
        const confidenceButtons = document.querySelectorAll('#likert-confidence .likert-btn');
        const diagnosisSection = document.getElementById('diagnosis-section');
        const steps = document.querySelectorAll('.instr-step');
        const modalBack = document.getElementById('modal-btn-back');
        const stepDotsContainer = document.getElementById('step-indicators');
        let currentStep = 0;
        
        // Inputs (Issue UI)
        const issueNone = document.getElementById('issue-none');
        const issueCheckboxes = document.querySelectorAll('.issue-checkbox');
        const issueOther = document.getElementById('issue-other');
        const otherInputContainer = document.getElementById('other-input-container');
        const otherInput = document.getElementById('other-input');


        document.addEventListener('DOMContentLoaded', () => {
            // Build dots
            steps.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = 'step-dot' + (i === 0 ? ' active' : '');
                stepDotsContainer.appendChild(dot);
            });
            const stepDots = stepDotsContainer.querySelectorAll('.step-dot');

            function updateModalUI() {
                steps.forEach((step, idx) => {
                    step.classList.toggle('active', idx === currentStep);
                });
                stepDots.forEach((dot, idx) => {
                    dot.classList.toggle('active', idx === currentStep);
                });
                modalBack.style.visibility = currentStep === 0 ? 'hidden' : 'visible';
                if (currentStep === steps.length - 1) {
                    modalNext.textContent = 'Start Task';
                    modalNext.style.backgroundColor = '#28a745';
                } else {
                    modalNext.textContent = 'Next';
                    modalNext.style.backgroundColor = '#007bff';
                }
            }

            modalNext.addEventListener('click', () => {
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    updateModalUI();
                } else {
                    modalOverlay.style.display = 'none';
                }
            });

            modalBack.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    updateModalUI();
                }
            });

            // --- RE-OPEN INSTRUCTIONS BUTTON ---
            document.getElementById('btn-show-help').addEventListener('click', () => {
                currentStep = 0;
                updateModalUI();
                modalOverlay.style.display = 'flex';
            });

            // Improvement Checkbox Logic
            const checks = document.querySelectorAll('input[name="improvement"]');
            const max = 3;
            checks.forEach(check => {
                check.addEventListener('change', function() {
                    const checkedCount = document.querySelectorAll('input[name="improvement"]:checked').length;
                    if (checkedCount > max) {
                        this.checked = false;
                        alert("You can only select 3 priorities.");
                    }
                    updateBeginQuizState();
                });
            });

            // Overall feedback likert interactions & enabling quiz
            const overallBtns = document.querySelectorAll('#overall-section .likert-btn');
            const exposureChecks = document.querySelectorAll('#overall-exposure input[type="checkbox"]');
            overallBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const group = btn.dataset.group;
                    document.querySelectorAll(`.likert-btn[data-group="${group}"]`).forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.querySelector(`input[name="${group}"]`)?.remove();
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = group;
                    hidden.value = btn.dataset.val;
                    document.getElementById('final-form').appendChild(hidden);
                    updateBeginQuizState();
                });
            });

            // Exposure checkbox logic (None of the above deselects others)
            exposureChecks.forEach(chk => {
                chk.addEventListener('change', () => {
                    if (chk.value === "None of the above" && chk.checked) {
                        exposureChecks.forEach(c => {
                            if (c !== chk) c.checked = false;
                        });
                    } else if (chk.value !== "None of the above" && chk.checked) {
                        const none = document.getElementById('exposure-none');
                        if (none) none.checked = false;
                    }
                    updateBeginQuizState();
                });
            });

            function updateBeginQuizState() {
                const hasFam = !!document.querySelector('input[name="overall_fam"]');
                const hasEff = !!document.querySelector('input[name="overall_effort"]');
                const hasConf = !!document.querySelector('input[name="overall_confidence"]');
                const hasImprovement = document.querySelectorAll('input[name="improvement"]:checked').length > 0;
                const exposureSelected = document.querySelectorAll('#overall-exposure input[type="checkbox"]:checked').length > 0;
                startQuizBtn.disabled = !(hasFam && hasEff && hasConf && hasImprovement && exposureSelected);
            }

            // Init Text
            const urlParams = new URLSearchParams(window.location.search);
            const stimulusID = urlParams.get('stimulus') || "text_01";
            const isSimplified = stimulusID.endsWith('_simp');
            // Expose flags for downstream saving/logging.
            window.isSimplifiedStimulus = isSimplified;
            const textSource = isSimplified ? (typeof studyTextsSimplified !== 'undefined' ? studyTextsSimplified : {}) : studyTexts;
            const stimulusData = textSource[stimulusID] || textSource["text_01"] || {};
            // Keep provenance handy for logging/analysis (split index -> original sentence index).
            const provenanceMap = isSimplified && typeof simplifiedMap !== 'undefined' ? (simplifiedMap[stimulusID] || {}) : null;
            const topicText = (typeof studyTopics !== 'undefined' && studyTopics[stimulusID]) ? studyTopics[stimulusID] : (urlParams.get('topic') || "a medical topic");
            const topicSpan = document.getElementById('instruction-topic');
            if (topicSpan) topicSpan.textContent = topicText;
            quizHighlightDisabled = urlParams.get('quiz_highlight') !== 'on';
            // Expose provenance for downstream logging/analysis if needed.
            window.stimulusProvenance = provenanceMap;

            // Build ordered sentence list from the segmented data (object keyed by sentence index).
            let sentenceList = [];
            if (Array.isArray(stimulusData)) {
                sentenceList = stimulusData.map(s => (s || '').trim()).filter(Boolean);
            } else if (stimulusData && typeof stimulusData === 'object') {
                sentenceList = Object.keys(stimulusData)
                    .sort((a, b) => Number(a) - Number(b))
                    .map(key => (stimulusData[key] || '').trim())
                    .filter(Boolean);
            } else if (typeof stimulusData === 'string') {
                sentenceList = [stimulusData.trim()];
            }

            if (sentenceList.length === 0) {
                sentenceList = ["Content unavailable."];
            }

            sentences = sentenceList;
            totalSentencesSpan.textContent = sentences.length;

            // Render Sentences
            textPanel.innerHTML = sentences.map((s, i) => 
                `<span class="sentence" id="sent-${i}" onclick="jumpTo(${i})">${s} </span>`
            ).join('');

            updateSpotlight();

            // --- EVENT LISTENERS ---

            // Likert Selection - effort
            effortButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = parseInt(btn.dataset.val);
                    setRating(val);
                });
            });

            // Likert Selection - confidence
            confidenceButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = parseInt(btn.dataset.val);
                    setConfidence(val);
                });
            });


            // Navigation
            btnPrev.addEventListener('click', () => {
                saveCurrentData();
                if (currentIndex > 0) {
                    currentIndex--;
                    updateSpotlight();
                }
            });

            btnNext.addEventListener('click', () => {
                saveCurrentData();
                currentIndex++;
                
                if (currentIndex < sentences.length) {
                    updateSpotlight();
                } else {
                    enterQuizMode();
                }
            });

            // --- Issue UI behavior---
            function setOtherVisible(show) {
                if (!otherInputContainer) return;
                otherInputContainer.style.display = show ? 'block' : 'none';
                if (!show && otherInput) otherInput.value = '';
            }

            // Start hidden by default (we'll remove your temporary display:block behavior)
            setOtherVisible(issueOther && issueOther.checked);

            // If "No issue" checked, clear all issues
            if (issueNone) {
                issueNone.addEventListener('change', () => {
                    if (issueNone.checked) {
                        issueCheckboxes.forEach(cb => cb.checked = false);
                        setOtherVisible(false);
                    }
                    updateNavState(); // <-- ADD THIS LINE
                });
            }

            // If any issue checked, uncheck "No issue". Also toggle Other textbox.
            issueCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const anyIssueChecked = Array.from(issueCheckboxes).some(x => x.checked);
                    if (issueNone && anyIssueChecked) issueNone.checked = false;
                    setOtherVisible(issueOther && issueOther.checked);

                    updateNavState(); // <-- ADD THIS LINE
                });
            });
        });

        // --- CORE FUNCTIONS ---

        // Jump to sentence (onclick)
        window.jumpTo = (index) => {
            // Only allow jumping if we are still in annotation mode
            if(finalFeedback.classList.contains('active')) return; 
            
            saveCurrentData();
            currentIndex = index;
            updateSpotlight();
        }

        function updateSpotlight() {
            // 1. Visual Highlight
            sentences.forEach((_, i) => {
                const el = document.getElementById(`sent-${i}`);
                if (i === currentIndex) {
                    el.className = 'sentence active';
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    el.className = 'sentence dimmed';
                }
            });

            // 2. UI State
            progressIndicator.textContent = currentIndex + 1;
            btnPrev.disabled = (currentIndex === 0);
            btnNext.textContent = (currentIndex === sentences.length - 1) ? "Next Stage" : "Next";
            
            // 3. Load Existing Data (if any)
            resetForm();
            if (annotations[currentIndex]) {
                const data = annotations[currentIndex];
                setRating(data.rating, false); // Load rating without clearing diagnosis
                setConfidence(data.confidence, false);
                // Restore issue selections
                if (issueNone) issueNone.checked = !!data.no_issue;

                if (issueCheckboxes) {
                    issueCheckboxes.forEach(cb => {
                        cb.checked = Array.isArray(data.issues) ? data.issues.includes(cb.value) : false;
                    });
                }

                if (otherInput) otherInput.value = data.other_text || "";

                // Show/hide Other box
                if (otherInputContainer && issueOther) {
                    otherInputContainer.style.display = issueOther.checked ? 'block' : 'none';
                }
            }
            updateNavState();
        }

        function setRating(val, clearDiagnosis = true) {
            effortButtons.forEach(b => {
                b.classList.remove('selected');
                if (parseInt(b.dataset.val) === val) b.classList.add('selected');
            });
            updateNavState();
        }

        function setConfidence(val, clearDiagnosis = true) {
            confidenceButtons.forEach(b => {
                b.classList.remove('selected');
                if (parseInt(b.dataset.val) === val) b.classList.add('selected');
            });
            updateNavState();
        }

        function getSelectedRating() {
            const sel = document.querySelector('#likert-effort .likert-btn.selected');
            return sel ? parseInt(sel.dataset.val) : null;
        }

        function getSelectedConfidence() {
            const sel = document.querySelector('#likert-confidence .likert-btn.selected');
            return sel ? parseInt(sel.dataset.val) : null;
        }

        function allSentencesCompleted(currentRating, currentConfidence, currentIssueOk) {
            if (!sentences || !sentences.length) return false;

            for (let i = 0; i < sentences.length; i++) {
                if (i === currentIndex) {
                    if (currentRating === null || currentRating === undefined) return false;
                    if (currentConfidence === null || currentConfidence === undefined) return false;
                    if (!currentIssueOk) return false;
                    continue;
                }

                const data = annotations[i];
                const hasRating = data && data.rating !== null && data.rating !== undefined;
                const hasConf = data && data.confidence !== null && data.confidence !== undefined;

                const hasIssues =
                    data &&
                    (data.no_issue === true ||
                    (Array.isArray(data.issues) && data.issues.length > 0));

                if (!hasRating || !hasConf || !hasIssues) return false;
            }
            return true;
        }


        function issueSelectionComplete() {
            const noIssue = issueNone && issueNone.checked;
            const anyIssue = issueCheckboxes && Array.from(issueCheckboxes).some(cb => cb.checked);
            return !!(noIssue || anyIssue);
        }

        function updateNavState() {
            const ratingVal = getSelectedRating();
            const confidenceVal = getSelectedConfidence();

            const issueOk = issueSelectionComplete();
            const currentComplete = ratingVal !== null && confidenceVal !== null && issueOk;

            const allComplete = allSentencesCompleted(ratingVal, confidenceVal, issueOk);

            const allowNext = currentComplete && (currentIndex !== sentences.length - 1 ? true : allComplete);

            if (allowNext) {
                btnNext.classList.add('active');
                btnNext.disabled = false;
            } else {
                btnNext.classList.remove('active');
                btnNext.disabled = true;
            }
        }


        function saveCurrentData() {
            const ratingVal = getSelectedRating();
            const confidenceVal = getSelectedConfidence();
            if (ratingVal === null || confidenceVal === null) return; // Need both

            const splitIndex = currentIndex + 1; // 1-based for clarity in exports
            const mappedIndex = window.isSimplifiedStimulus
                ? (window.stimulusProvenance ? (window.stimulusProvenance[String(splitIndex)] || null) : null)
                : splitIndex; // originals map to themselves

            annotations[currentIndex] = {
                text: sentences[currentIndex],
                sentence_index: splitIndex,
                mapped_sentence_index: mappedIndex,
                rating: ratingVal,
                confidence: confidenceVal,
                no_issue: issueNone ? issueNone.checked : false,
                issues: issueCheckboxes ? Array.from(issueCheckboxes).filter(cb => cb.checked).map(cb => cb.value) : [],
                other_text: otherInput ? (otherInput.value || "") : "",
                // Optional: keep legacy field name so downstream doesn't break
                feedbackText: otherInput ? (otherInput.value || "") : ""

            };
        }

        function resetForm() {
            effortButtons.forEach(b => b.classList.remove('selected'));
            confidenceButtons.forEach(b => b.classList.remove('selected'));
            if (issueNone) issueNone.checked = false;
            if (issueCheckboxes) issueCheckboxes.forEach(cb => cb.checked = false);
            if (otherInput) otherInput.value = '';
            if (otherInputContainer) otherInputContainer.style.display = 'none';
            btnNext.classList.remove('active');
            btnNext.disabled = true;
        }

        // --- QUIZ MODE ---
        function enterQuizMode() {
            spotlightControls.style.display = 'none';
            finalFeedback.classList.add('active');

            // OPEN BOOK: Remove dimming from all sentences
            document.querySelectorAll('.sentence').forEach(el => {
                el.className = 'sentence'; // Removes .dimmed and .active
                el.style.cursor = 'default';
            });

            // Prepare for quiz-after-overall flow
            quizContainer.style.display = 'none';
            quizContainer.innerHTML = '<p>Please complete the overall feedback, then click "Begin Quiz" to continue.</p>';
            quizCompleteMessage.style.display = 'none';
            quizSummary.style.display = 'none';
            startQuizBtn.style.display = 'inline-block';
            overallSection.style.display = 'block';
            startQuizBtn.disabled = true;
            quizLocked = false;
            
            // Scroll sidebar to top
            document.querySelector('.sidebar-right').scrollTop = 0;
        }

        // --- QUIZ FLOW ---
        let quizQuestions = [];
        let quizIndex = 0;
        const quizResponses = {}; // idx -> {sentence_id, selected_option, correct_answer, is_correct, question, difficulty, options}
        const quizOptionOrder = {}; // idx -> shuffled array of [key, text]
        let quizHighlightDisabled = true;
        let quizLocked = false; // Prevent edits after showing answers

        // Start quiz only after overall feedback section
        startQuizBtn.addEventListener('click', () => {
            setupQuizFlow();
            quizContainer.style.display = 'block';
            overallSection.style.display = 'none';
            quizCompleteMessage.style.display = 'none';
        });

        function setupQuizFlow() {
            const urlParams = new URLSearchParams(window.location.search);
            const stimulusID = urlParams.get('stimulus') || "text_01";
            const isSimplifiedStimulus = stimulusID.endsWith('_simp');
            const baseQuizKey = isSimplifiedStimulus ? stimulusID.replace(/_simp$/, '') : stimulusID;
            // Prefer simplified-specific quizzes when provided; otherwise fall back to base quizzes.
            const simplifiedOverride = (isSimplifiedStimulus && typeof studyQuizzesSimplified !== 'undefined')
                ? studyQuizzesSimplified[stimulusID]
                : undefined;
            quizQuestions = simplifiedOverride !== undefined ? simplifiedOverride : (studyQuizzes[baseQuizKey] || []);
            quizIndex = 0;
            Object.keys(quizOptionOrder).forEach(k => delete quizOptionOrder[k]);
            quizLocked = false;

            if (quizQuestions.length === 0) {
                quizContainer.innerHTML = '<p>No questions for this text.</p>';
                quizSummary.style.display = 'none';
                return;
            }
            quizCompleteMessage.style.display = 'none';
            document.getElementById('btn-submit-final').style.display = 'none';
            quizSummary.style.display = 'none';
            renderCurrentQuizQuestion();
        }

        function renderCurrentQuizQuestion() {
            if (quizQuestions.length === 0) return;
            const q = quizQuestions[quizIndex];
            quizContainer.innerHTML = '';
            quizCompleteMessage.style.display = 'none';

            const block = document.createElement('div');
            block.className = 'quiz-block';

            let html = `<h3 style="margin-top:0;">Step 3. Comprehension Questions</h3>`;

            const optionEntries = Object.entries(q.options || {});
            const order = quizOptionOrder[quizIndex] || shuffleOptions(optionEntries);
            quizOptionOrder[quizIndex] = order;
            const rawQuestion = q.question || "";
            const cleanedQuestion = rawQuestion.replace(/^Answer the question based on the highlighted sentence\.?\s*/i, '').trim() || rawQuestion;
            html += `<label class="quiz-question-text"><strong>Q${quizIndex + 1} of ${quizQuestions.length}. ${cleanedQuestion}</strong></label>`;

            order.forEach(([key, text]) => {
                const inputName = `quiz_${quizIndex}_ans`;
                html += `
                <div class="form-option">
                    <input type="radio" name="${inputName}" value="${key}">
                    <label>${text}</label>
                </div>`;
            });

            html += `
            <div class="quiz-meta-q">
                <label style="font-weight:bold; font-size:0.9em;">How much effort did answering this question take?</label>
                <div style="display:flex; justify-content:space-between; font-size: 0.8em; margin-top:5px;">
                    <span>Low</span>
                    <span>High</span>
                </div>
                <div style="display:flex; justify-content:space-between; gap:6px;">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="1">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="2">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="3">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="4">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="5">
                </div>

                <label style="font-weight:bold; font-size:0.9em; margin-top:10px; display:block;">How confident are you that you answered it correctly?</label>
                <div style="display:flex; justify-content:space-between; font-size: 0.8em; margin-top:5px;">
                    <span>Not confident</span>
                    <span>Very confident</span>
                </div>
                <div style="display:flex; justify-content:space-between; gap:6px;">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="1">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="2">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="3">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="4">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="5">
                </div>
            </div>
            <div class="nav-bar">
                <button type="button" class="btn-nav btn-prev" id="quiz-prev" ${quizIndex === 0 ? 'disabled' : ''}>Previous</button>
                <button type="button" class="btn-nav btn-next" id="quiz-next">${quizIndex === quizQuestions.length - 1 ? 'Finish' : 'Next'}</button>
            </div>`;

            block.innerHTML = html;
            quizContainer.appendChild(block);

            // Restore saved answers if any
            const saved = quizResponses[quizIndex];
            if (saved) {
                const ansInput = document.querySelector(`input[name="quiz_${quizIndex}_ans"][value="${saved.selected_option}"]`);
                if (ansInput) ansInput.checked = true;
                const effInput = document.querySelector(`input[name="quiz_${quizIndex}_effort"][value="${saved.effort_rating}"]`);
                if (effInput) effInput.checked = true;
                const confInput = document.querySelector(`input[name="quiz_${quizIndex}_conf"][value="${saved.confidence_rating}"]`);
                if (confInput) confInput.checked = true;
            }

            // Highlight the referenced sentence (toggle via URL: ?quiz_highlight=off)
            if (quizHighlightDisabled) {
                clearQuizHighlight();
            } else {
                highlightQuizSentence(q.sentence_id);
            }

            // Wire buttons
            const quizPrev = document.getElementById('quiz-prev');
            const quizNext = document.getElementById('quiz-next');
            const answerInputs = document.querySelectorAll(`input[name="quiz_${quizIndex}_ans"]`);
            const effortInputs = document.querySelectorAll(`input[name="quiz_${quizIndex}_effort"]`);
            const confInputs = document.querySelectorAll(`input[name="quiz_${quizIndex}_conf"]`);

            const updateNextState = () => {
                if (quizLocked) {
                    quizNext.classList.remove('active');
                    quizNext.disabled = true;
                    return;
                }
                const hasAnswer = document.querySelector(`input[name="quiz_${quizIndex}_ans"]:checked`);
                const hasEffort = document.querySelector(`input[name="quiz_${quizIndex}_effort"]:checked`);
                const hasConf = document.querySelector(`input[name="quiz_${quizIndex}_conf"]:checked`);
                if (hasAnswer && hasEffort && hasConf) {
                    quizNext.classList.add('active');
                    quizNext.disabled = false;
                } else {
                    quizNext.classList.remove('active');
                    quizNext.disabled = true;
                }
            };

            answerInputs.forEach(inp => inp.addEventListener('change', updateNextState));
            effortInputs.forEach(inp => inp.addEventListener('change', updateNextState));
            confInputs.forEach(inp => inp.addEventListener('change', updateNextState));
            updateNextState();

            quizPrev.addEventListener('click', () => {
                if (quizLocked) return;
                saveQuizAnswer();
                if (quizIndex > 0) {
                    quizIndex--;
                    renderCurrentQuizQuestion();
                }
            });
            quizNext.addEventListener('click', () => {
                if (quizLocked) return;
                const savedOk = saveQuizAnswer(true);
                if (!savedOk) return;
                if (quizIndex < quizQuestions.length - 1) {
                    quizIndex++;
                    renderCurrentQuizQuestion();
                } else {
                    // End of quiz: keep last question visible, just show submit
                    document.getElementById('btn-submit-final').style.display = 'block';
                    quizNext.disabled = true;
                    quizNext.classList.remove('active');
                    renderQuizSummary();
                    lockQuizInputs();
                }
            });

            if (quizLocked) {
                [quizPrev, quizNext].forEach(btn => btn && (btn.disabled = true));
                [...answerInputs, ...effortInputs, ...confInputs].forEach(inp => inp.disabled = true);
            }
        }

        function saveQuizAnswer(require = false) {
            const ansInput = document.querySelector(`input[name="quiz_${quizIndex}_ans"]:checked`);
            const effInput = document.querySelector(`input[name="quiz_${quizIndex}_effort"]:checked`);
            const confInput = document.querySelector(`input[name="quiz_${quizIndex}_conf"]:checked`);
            if (require && (!ansInput || !effInput || !confInput)) {
                alert("Please select an answer, effort, and understanding rating before continuing.");
                return false;
            }
            const q = quizQuestions[quizIndex];
            const correctKey = q.correct_answer || Object.keys(q.options || {})[0] || "";
            const selectedVal = ansInput ? ansInput.value : "";
            quizResponses[quizIndex] = {
                sentence_id: q.sentence_id !== undefined ? q.sentence_id : "",
                question: q.question || "",
                selected_option: selectedVal,
                effort_rating: effInput ? effInput.value : "",
                confidence_rating: confInput ? confInput.value : "",
                options: q.options || {},
                correct_answer: correctKey,
                is_correct: selectedVal === correctKey,
                selected_option_text: (q.options || {})[selectedVal] || ""
            };
            return true;
        }

        function highlightQuizSentence(sentenceId) {
            document.querySelectorAll('.sentence').forEach(el => {
                el.classList.remove('active');
                el.classList.add('dimmed');
            });
            if (sentenceId === undefined || sentenceId === null) return;
            const sidStr = String(sentenceId);
            const num = parseInt(sidStr.replace(/\\D/g, ''), 10);
            if (!isNaN(num)) {
                const idx = num - 1;
                const target = document.getElementById(`sent-${idx}`);
                if (target) {
                    target.classList.add('active');
                    target.scrollIntoView({behavior:'smooth', block:'center'});
                }
            }
        }

        function clearQuizHighlight() {
            document.querySelectorAll('.sentence').forEach(el => {
                el.classList.remove('active');
                el.classList.remove('dimmed');
            });
        }

        function shuffleOptions(arr) {
            const copy = arr.slice();
            for (let i = copy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [copy[i], copy[j]] = [copy[j], copy[i]];
            }
            return copy;
        }

        function renderQuizSummary() {
            if (!quizSummary || !quizSummaryList) return;
            quizSummaryList.innerHTML = '';
            if (!quizQuestions.length) {
                quizSummary.style.display = 'none';
                return;
            }

            quizQuestions.forEach((q, idx) => {
                const correctKey = q.correct_answer || Object.keys(q.options || {})[0] || "";
                const correctText = (q.options || {})[correctKey] || "Not provided";
                const userResponse = quizResponses[idx];
                const userKey = userResponse ? userResponse.selected_option : "";
                const isCorrect = userKey === correctKey;
                const userText = (q.options || {})[userKey] || (userKey ? userKey : "No answer");
                const questionText = (q.question || "").replace(/^Answer the question based on the highlighted sentence\.?\s*/i, '').trim() || (q.question || "");

                const entry = document.createElement('div');
                entry.style.background = '#fff';
                entry.style.border = '1px solid #d0d7de';
                entry.style.borderRadius = '6px';
                entry.style.padding = '10px 12px';

                entry.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:6px;">Q${idx + 1}. ${questionText}</div>
                    <div style="margin-bottom:4px;">Your answer: <span style="font-weight:${isCorrect ? 'bold' : 'normal'}; color:${isCorrect ? '#2e7d32' : '#b71c1c'};">${userText}</span></div>
                    <div>Correct answer: <strong>${correctText}</strong></div>
                `;
                quizSummaryList.appendChild(entry);
            });

            quizSummary.style.display = 'block';
            quizCompleteMessage.style.display = 'block';
        }

        function lockQuizInputs() {
            quizLocked = true;
            const prevBtn = document.getElementById('quiz-prev');
            const nextBtn = document.getElementById('quiz-next');
            if (prevBtn) prevBtn.disabled = true;
            if (nextBtn) nextBtn.disabled = true;

            const currentAnswerInputs = document.querySelectorAll(`input[name="quiz_${quizIndex}_ans"]`);
            const currentEffortInputs = document.querySelectorAll(`input[name="quiz_${quizIndex}_effort"]`);
            const currentConfInputs = document.querySelectorAll(`input[name="quiz_${quizIndex}_conf"]`);
            [...currentAnswerInputs, ...currentEffortInputs, ...currentConfInputs].forEach(inp => inp.disabled = true);
        }

        // --- SUBMIT ---
        document.getElementById('btn-submit-final').addEventListener('click', () => {
            const btn = document.getElementById('btn-submit-final');
            btn.textContent = "Submitting...";
            btn.disabled = true;

            const urlParams = new URLSearchParams(window.location.search);
            const stimulusID = urlParams.get('stimulus') || "text_01";
            
            const finalForm = document.getElementById('final-form');
            const formData = new FormData(finalForm);
            
            // Gather Improvements Checkboxes
            const improvements = [];
            document.querySelectorAll('input[name="improvement"]:checked').forEach(c => improvements.push(c.value));

            // Gather Quiz Answers from sequential flow
            const quizResults = Object.keys(quizResponses).sort((a,b)=>Number(a)-Number(b)).map(idx => quizResponses[idx]);

            // Format Annotations for Google Sheets (Map to Array)
            // Keep the original sentence order (numeric keys 1,2,3,... not 1,10,2)
            const annotationArray = Object.keys(annotations)
                .map(k => Number(k))
                .sort((a, b) => a - b)
                .map(k => annotations[k]);

            const topicFam = formData.get('overall_fam') || "N/A";
            const exposures = Array.from(document.querySelectorAll('#overall-exposure input[type=\"checkbox\"]:checked')).map(c => c.value);
            const overallEffortVal = formData.get('overall_effort') || "N/A";
            const overallConfVal = formData.get('overall_confidence') || "N/A";

            const payload = {
                worker_id: urlParams.get('PROLIFIC_PID') || "TEST_USER",
                study_id: urlParams.get('STUDY_ID') || "TEST_STUDY",       // NEW: Matches Col C in AppScript
                session_id: urlParams.get('SESSION_ID') || "TEST_SESSION", // NEW: Matches Col D in AppScript
                stimulus_id: stimulusID,
                is_simplified: stimulusID.endsWith('_simp'),
                provenance_map: (typeof window.stimulusProvenance !== 'undefined' ? window.stimulusProvenance : null),
                // Pack familiarity + reading frequency together to fit existing App Script field
                familiarity: JSON.stringify({
                    topic_familiarity: topicFam,
                    reading_exposure: exposures
                }),
                overall_difficulty: overallEffortVal, // mapped to effort
                confidence: overallConfVal,
                overall_effort: overallEffortVal,
                overall_confidence: overallConfVal,
                improvements: improvements.join(', '),
                annotations: annotationArray,
                quiz_results: quizResults
            };

            fetch(submissionURL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(payload)
            }).then(() => {
                const cc = urlParams.get('cc') || "TEST_CODE";
                window.location.href = "https://app.prolific.com/submissions/complete?cc=" + cc;
            }).catch(err => {
                alert("Error submitting. See console.");
                console.error(err);
                btn.disabled = false;
            });
        });
    </script>
</body>
</html>
