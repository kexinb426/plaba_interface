<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Difficulty Annotator (Spotlight)</title>
    <style>
        /* Basic Setup */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
            overflow-y: hidden; /* Prevent body scroll, handle in layout */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 16px; border-radius: 8px;
            max-width: 900px; width: 80%;
            max-height: 120vh;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .modal-content h2 { margin: 6px 0 10px; color: #007bff; font-size: 1.2rem; }
        .modal-content h3 { margin: 8px 0 6px; font-size: 1.05rem; }
        .modal-content p { margin: 4px 0; }
        .modal-content li { margin: 4px 0; }
        .modal-content ul { margin-top: 2px; margin-bottom: 6px; }
        .modal-content ol { margin-top: 4px; margin-bottom: 8px; padding-left: 18px; }
        .example-box {
            background: #f1f3f5; padding: 15px; border-radius: 5px;
            margin: 15px 0; border-left: 4px solid #007bff;
        }
        .good-ex { color: #2e7d32; font-weight: bold; }
        .bad-ex { color: #c62828; font-weight: bold; }
        .btn-start {
            background-color: #007bff; color: white; padding: 12px 24px;
            font-size: 1.1rem; width: 100%; margin-top: 10px; cursor: pointer; border:none; border-radius:4px;
        }

        /* --- MULTI-PAGE MODAL UPDATES --- */
        .instr-step {
            display: none; /* Hide all steps by default */
            animation: fadeIn 0.3s;
        }
        .instr-step.active {
            display: block; /* Show only the active step */
        }

        .modal-nav-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .btn-modal-nav {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn-modal-back {
            background: #f1f3f5;
            color: #555;
        }
        .btn-modal-next {
            background: #007bff;
            color: white;
        }
        .btn-modal-next:hover { background: #0056b3; }

        /* Simple fade animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Progress Dots */
        .step-indicators {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .step-dot {
            width: 10px;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .step-dot.active {
            background-color: #007bff;
            transform: scale(1.2);
        }

        /* Layout */
        .top-bar {
            background: #fff; padding: 10px 20px;
            border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .layout {
            display: flex;
            flex: 1; /* Fill remaining height */
            padding: 20px;
            gap: 20px;
            overflow: hidden; /* Contain scrolls */
        }

        .text-panel {
            flex: 2;
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-y: auto;
            font-size: 1.25rem;
            line-height: 2;
            color: #222;
        }
        
        .sidebar-right {
            flex: 1;
            min-width: 350px;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* Button */
        .btn-help {
            background: transparent;
            border: 1px solid #ccc;
            color: #555;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-help:hover {
            background: #f1f1f1;
            border-color: #bbb;
            color: #333;
        }

        /* --- SPOTLIGHT STYLES (NEW) --- */
        .sentence {
            transition: all 0.3s ease;
            padding: 2px 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .sentence.dimmed {
            opacity: 0.3;
            filter: blur(0px); /* Optional blur */
        }
        .sentence.active {
            opacity: 1;
            background-color: #fff9c4; /* Soft yellow highlight */
            box-shadow: 0 0 0 3px #fbc02d; /* Solid border/glow */
            font-weight: 500;
        }

        /* --- CONTROLS --- */
        .control-card {
            background: #fff; padding: 20px;
            border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .control-card h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* Likert Scale */
        .likert-scale { display: flex; gap: 5px; margin-bottom: 20px; }
        .likert-btn {
            flex: 1; padding: 10px 5px; text-align: center;
            border: 1px solid #ddd; border-radius: 4px;
            cursor: pointer; background: #fff; transition: all 0.2s;
            font-weight: bold; color: #555;
        }
        .likert-btn:hover { background: #f8f9fa; border-color: #bbb; }
        .likert-btn.selected {
            background-color: #007bff; color: white; border-color: #007bff;
            transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .likert-label { display: block; font-size: 0.75rem; font-weight: normal; margin-top: 4px; }

        /* Diagnosis Form */
        #diagnosis-section { display: block; margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px; }
        .checkbox-option { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer; }
        .checkbox-option input { transform: scale(1.2); }
        
        #vocab-input-container, #other-input-container { margin-left: 25px; display: none; margin-bottom: 10px; }
        #vocab-input, #other-input { width: 90%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }

        /* Navigation Buttons */
        .nav-bar { display: flex; gap: 10px; margin-top: 20px; }
        .btn-nav {
            flex: 1; padding: 12px; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; font-size: 1rem;
        }
        .btn-prev { background-color: #e2e6ea; color: #333; }
        .btn-next { background-color: #007bff; color: white; opacity: 0.5; pointer-events: none; }
        .btn-next.active { opacity: 1; pointer-events: auto; }
        .btn-next:hover { background-color: #0056b3; }
        .btn-nav:disabled,
        .btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quiz Panel */
        #final-feedback { display: none; }
        #final-feedback.active { display: block; }
        .quiz-block { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #eee; }
        .question-label { font-weight: bold; display: block; margin-bottom: 10px; }
        .form-option { margin-bottom: 5px; }
        .quiz-meta-q {
            margin-top: 10px; padding-top: 10px;
            border-top: 1px dashed #ccc; font-size: 0.9em; color: #555;
        }

        /* Improvements Checkboxes */
        .checkbox-group {
            display: flex; flex-direction: column; gap: 12px; margin-top: 10px;
        }

    </style>
</head>
<body>

    <!-- Instructions Modal -->
    <div id="instruction-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="instr-step active">
                <h2>üëã Thank you for participating!</h2>
                <p>In this study, you will read a medical abstract about <strong><span id="instruction-topic">{topic}</span></strong>.</p>
                <p><strong>Please imagine you're reading this text to find important medical information for yourself or a family member.</strong></p>
                <p>Your responses will help us understand which parts of medical writing are easy or difficult for everyday readers.</p>

                <h3>What you will do</h3>

                <ol>
                    <li>
                        <strong>Rate each sentence</strong><br>
                        As you read the abstract, each sentence will be <strong>highlighted in turn</strong>.
                        For each highlighted sentence, you will rate:
                        <ul style="margin-top:4px; margin-bottom:4px;">
                            <li><strong>Reading Effort</strong> ‚Äî how hard the sentence was to read.</li>
                            <li><strong>Understanding Confidence</strong> ‚Äî how sure you are that you understood it.</li>
                        </ul>
                        If anything feels difficult to understand, you can optionally leave a brief comment.
                    </li>

                    <li>
                        <strong>Give your overall impressions</strong><br>
                        After rating all sentences, you will answer a few questions about the text as a whole.
                    </li>

                    <li>
                        <strong>Complete a short comprehension quiz</strong><br>
                        Finally, you will answer <strong>several questions</strong> to check your understanding of the content.
                    </li>
                </ol>

                <div style="background-color:#f7f9fc; padding:12px; border-left:4px solid #3498db; margin:18px 0; font-size:0.9em;">
                    <p style="margin:0 0 6px 0;"><strong>How to use the rating scales</strong></p>

                    <p style="margin:6px 0 2px 0;"><strong>Reading Effort (1‚Äì5)</strong></p>
                    <ul style="margin:0 0 8px 18px; padding:0;">
                        <li><strong>1 ‚Äì No effort:</strong> Very easy to read; no pauses or rereading.</li>
                        <li><strong>5 ‚Äì Very high effort:</strong> Very hard to read; you needed to slow down or reread multiple times.</li>
                    </ul>

                    <p style="margin:8px 0 2px 0;"><strong>Understanding Confidence (1‚Äì5)</strong></p>
                    <ul style="margin:0 0 0 18px; padding:0;">
                        <li><strong>1 ‚Äì Not confident:</strong> You understood almost none of it. You could not explain what it means.</li>
                        <li><strong>5 ‚Äì Very confident:</strong> You fully understand the meaning and could answer a question about it.</li>
                    </ul>
                </div>
            </div>

            <div class="modal-nav-bar" style="margin-top: 16px; justify-content: flex-end;">
                <button class="btn-modal-nav btn-modal-next" id="modal-btn-next">Start Task</button>
            </div>

        </div> <!-- modal-content -->
    </div> <!-- modal-overlay -->


    <!-- Top Header -->
    <div class="top-bar" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin:0; font-size: 1.2rem;">üè• Medical Clarity Study</h2>
        <button id="btn-show-help" class="btn-help">‚ùìInstructions</button>
    </div>
    
    <!-- Main Layout -->
    <div class="layout">
    
        <!-- Text Panel (Left) -->
        <div class="text-panel" id="text-panel">
            <!-- Sentences injected here -->
        </div>
    
        <!-- Sidebar (Right) -->
        <div class="sidebar-right">
            
            <!-- --- SPOTLIGHT CONTROLS --- -->
            <div class="control-card" id="spotlight-controls">
                <h3>
                    Step 1. Sentence Analysis
                    <span style="font-size:0.8rem; float:right; color:#777; margin-top:4px;">
                        <span id="progress-indicator">1</span> / <span id="total-sentences">0</span>
                    </span>
                </h3>

                <p class="question-label" style="margin-bottom:6px;">1. While reading, how much effort did this sentence take?</p>
                
                <div class="likert-scale" id="likert-effort">
                    <div class="likert-btn" data-val="1">1<span class="likert-label">No effort</span></div>
                    <div class="likert-btn" data-val="2">2<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="3">3<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="4">4<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="5">5<span class="likert-label">Very high effort</span></div>
                </div>

                <p class="question-label" style="margin:12px 0 6px;">2. How confident are you that you understood this sentence well enough to answer a question about it?</p>
                <div class="likert-scale" id="likert-confidence">
                    <div class="likert-btn" data-val="1">1<span class="likert-label">Not confident</span></div>
                    <div class="likert-btn" data-val="2">2<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="3">3<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="4">4<span class="likert-label"></span></div>
                    <div class="likert-btn" data-val="5">5<span class="likert-label">Very confident</span></div>
                </div>

                <!-- Feedback box -->
                <div id="diagnosis-section" class="feedback-box" style="margin-top:12px; padding:10px; border:1px solid #eee; border-radius:6px; background:#f9fafb;">
                    <p class="question-label" style="margin:0 0 8px 0;">If something was hard to understand, please tell us here.</p>
                    <p style="margin:0 0 8px 0; font-size:0.9rem; color:#555;">(You can copy/paste the part, describe what felt unclear, or ask any questions.)</p>
                    <textarea id="sentence-feedback" rows="3" style="width:95%; border:1px solid #ccc; border-radius:4px; padding:8px; resize: vertical;" placeholder="Optional"></textarea>
                    <label class="checkbox-option" style="margin-top:8px;">
                        <input type="checkbox" id="sentence-entire-hard">
                        <span>The whole sentence was hard to understand</span>
                    </label>
                </div>

                <div class="nav-bar">
                    <button class="btn-nav btn-prev" id="btn-prev">Previous</button>
                    <button class="btn-nav btn-next" id="btn-next">Next</button>
                </div>
            </div>

            <!-- --- QUIZ PANEL (Initially Hidden) --- -->
            <div class="control-card" id="final-feedback">
                <form id="final-form">
                    <div id="overall-section">
                        <h3>Step 2. Overall Feedback</h3>
            
                        <label class="question-label">Q1. How familiar were you with this topic before reading?</label>
                        <div class="likert-scale" id="overall-fam">
                            <div class="likert-btn" data-group="overall_fam" data-val="1">1<span class="likert-label">Not familiar</span></div>
                            <div class="likert-btn" data-group="overall_fam" data-val="2">2<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_fam" data-val="3">3<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_fam" data-val="4">4<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_fam" data-val="5">5<span class="likert-label">Very familiar</span></div>
                        </div>

                        <label class="question-label" style="margin-top: 16px;">Q2. How often do you read academic or scientific texts?</label>
                        <div class="likert-scale" id="overall-freq">
                            <div class="likert-btn" data-group="overall_freq" data-val="1">1<span class="likert-label">Never</span></div>
                            <div class="likert-btn" data-group="overall_freq" data-val="2">2<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_freq" data-val="3">3<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_freq" data-val="4">4<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_freq" data-val="5">5<span class="likert-label">Very often</span></div>
                        </div>

                        <label class="question-label" style="margin-top: 20px;">Q3. How much effort did it take to read this text?</label>
                        <div class="likert-scale" id="overall-eff">
                            <div class="likert-btn" data-group="overall_effort" data-val="1">1<span class="likert-label">No effort</span></div>
                            <div class="likert-btn" data-group="overall_effort" data-val="2">2<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_effort" data-val="3">3<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_effort" data-val="4">4<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_effort" data-val="5">5<span class="likert-label">Very high effort</span></div>
                        </div>

                        <label class="question-label" style="margin-top: 20px;">Q4. How confident are you that you understood the main points of the text?</label>
                        <div class="likert-scale" id="overall-conf">
                            <div class="likert-btn" data-group="overall_confidence" data-val="1">1<span class="likert-label">Not confident</span></div>
                            <div class="likert-btn" data-group="overall_confidence" data-val="2">2<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_confidence" data-val="3">3<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_confidence" data-val="4">4<span class="likert-label"></span></div>
                            <div class="likert-btn" data-group="overall_confidence" data-val="5">5<span class="likert-label">Very confident</span></div>
                        </div>

                        <div class="final-comments">
                            <label class="question-label" style="margin-top: 20px;">
                                Q5. If you could improve this text, what are the changes that would help the most (select at most 3)?
                            </label>
                            
                            <div class="checkbox-group" id="wishlist-group">
                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="simpler_vocab">
                                    <span><strong>Use everyday words</strong> (Swap hard words for simple ones)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="definitions">
                                    <span><strong>Define the terms</strong> (Keep the terms, but explain what they mean)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="shorter_sentences">
                                    <span><strong>Shorten sentences</strong> (Break long sentences into chunks)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="better_flow">
                                    <span><strong>Connect the ideas</strong> (Make it clearer how one point leads to the next)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="reorder">
                                    <span><strong>Group related info</strong> (The order of information is confusing)</span>
                                </label>

                                <label class="checkbox-option">
                                    <input type="checkbox" name="improvement" value="significance">
                                    <span><strong>Explain the impact</strong> (Tell me if this is good/bad news)</span>
                                </label>
                            </div>
                        </div>

                        <button type="button" class="btn-start" id="btn-start-quiz" style="margin-top:20px;" disabled>Begin Quiz</button>
                    </div>

                    <div id="quiz-container" style="margin-top:20px; display:none;"></div>

                    <div id="quiz-complete-message" style="display:none; margin-top:15px; font-weight:bold; color:#2e7d32;">
                        Quiz complete. You can submit your responses now.
                    </div>

                    <button type="button" class="btn-start" id="btn-submit-final" style="margin-top:20px; display:none;">Submit All Data</button>
                </form>
            </div>

        </div>
    </div>

    <script src="studyConfig.js"></script>
    <script src="studyData.js"></script>
    <script>
        // --- CONFIG ---
        const submissionURL = (typeof googleScriptURL === 'string' && googleScriptURL.trim().length > 0)
            ? googleScriptURL
            : "https://script.google.com/macros/s/AKfycbwefYLFqc-MUxps38IuE6pQAxOIQtg3x-ytywkMhfbISoQLBwmQRBbMPCKZSFWd7YhrOQ/exec";
        // --- STATE ---
        let sentences = [];
        let currentIndex = 0;
        // Map: index -> { rating, confidence, feedbackText, entireHard }
        let annotations = {};

        // --- DOM ---
        const textPanel = document.getElementById('text-panel');
        const spotlightControls = document.getElementById('spotlight-controls');
        const finalFeedback = document.getElementById('final-feedback');
        const progressIndicator = document.getElementById('progress-indicator');
        const totalSentencesSpan = document.getElementById('total-sentences');
        const quizContainer = document.getElementById('quiz-container');
        const quizCompleteMessage = document.getElementById('quiz-complete-message');
        const overallSection = document.getElementById('overall-section');
        const startQuizBtn = document.getElementById('btn-start-quiz');
        const modalOverlay = document.getElementById('instruction-modal');
        const modalNext = document.getElementById('modal-btn-next');
        
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const effortButtons = document.querySelectorAll('#likert-effort .likert-btn');
        const confidenceButtons = document.querySelectorAll('#likert-confidence .likert-btn');
        const diagnosisSection = document.getElementById('diagnosis-section');
        
        // Inputs
        const sentenceFeedback = document.getElementById('sentence-feedback');
        const sentenceEntireHard = document.getElementById('sentence-entire-hard');

        document.addEventListener('DOMContentLoaded', () => {
            // --- Simple modal logic (single page) ---
            modalNext.addEventListener('click', () => {
                modalOverlay.style.display = 'none';
            });

            // --- RE-OPEN INSTRUCTIONS BUTTON ---
            document.getElementById('btn-show-help').addEventListener('click', () => {
                modalOverlay.style.display = 'flex';
            });

            // Improvement Checkbox Logic
            const checks = document.querySelectorAll('input[name="improvement"]');
            const max = 3;
            checks.forEach(check => {
                check.addEventListener('change', function() {
                    const checkedCount = document.querySelectorAll('input[name="improvement"]:checked').length;
                    if (checkedCount > max) {
                        this.checked = false;
                        alert("You can only select 3 priorities.");
                    }
                    updateBeginQuizState();
                });
            });

            // Overall feedback likert interactions & enabling quiz
            const overallBtns = document.querySelectorAll('#overall-section .likert-btn');
            overallBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const group = btn.dataset.group;
                    document.querySelectorAll(`.likert-btn[data-group="${group}"]`).forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.querySelector(`input[name="${group}"]`)?.remove();
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = group;
                    hidden.value = btn.dataset.val;
                    document.getElementById('final-form').appendChild(hidden);
                    updateBeginQuizState();
                });
            });

            function updateBeginQuizState() {
                const hasFam = !!document.querySelector('input[name="overall_fam"]');
                const hasFreq = !!document.querySelector('input[name="overall_freq"]');
                const hasEff = !!document.querySelector('input[name="overall_effort"]');
                const hasConf = !!document.querySelector('input[name="overall_confidence"]');
                const hasImprovement = document.querySelectorAll('input[name="improvement"]:checked').length > 0;
                startQuizBtn.disabled = !(hasFam && hasFreq && hasEff && hasConf && hasImprovement);
            }

            // Init Text
            const urlParams = new URLSearchParams(window.location.search);
            const stimulusID = urlParams.get('stimulus') || "text_01";
            const stimulusData = studyTexts[stimulusID] || studyTexts["text_01"] || {};
            const topicText = (typeof studyTopics !== 'undefined' && studyTopics[stimulusID]) ? studyTopics[stimulusID] : (urlParams.get('topic') || "a medical topic");
            const topicSpan = document.getElementById('instruction-topic');
            if (topicSpan) topicSpan.textContent = topicText;

            // Build ordered sentence list from the segmented data (object keyed by sentence index).
            let sentenceList = [];
            if (Array.isArray(stimulusData)) {
                sentenceList = stimulusData.map(s => (s || '').trim()).filter(Boolean);
            } else if (stimulusData && typeof stimulusData === 'object') {
                sentenceList = Object.keys(stimulusData)
                    .sort((a, b) => Number(a) - Number(b))
                    .map(key => (stimulusData[key] || '').trim())
                    .filter(Boolean);
            } else if (typeof stimulusData === 'string') {
                sentenceList = [stimulusData.trim()];
            }

            if (sentenceList.length === 0) {
                sentenceList = ["Content unavailable."];
            }

            sentences = sentenceList;
            totalSentencesSpan.textContent = sentences.length;

            // Render Sentences
            textPanel.innerHTML = sentences.map((s, i) => 
                `<span class="sentence" id="sent-${i}" onclick="jumpTo(${i})">${s} </span>`
            ).join('');

            updateSpotlight();

            // --- EVENT LISTENERS ---

            // Likert Selection - effort
            effortButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = parseInt(btn.dataset.val);
                    setRating(val);
                });
            });

            // Likert Selection - confidence
            confidenceButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = parseInt(btn.dataset.val);
                    setConfidence(val);
                });
            });


            // Navigation
            btnPrev.addEventListener('click', () => {
                saveCurrentData();
                if (currentIndex > 0) {
                    currentIndex--;
                    updateSpotlight();
                }
            });

            btnNext.addEventListener('click', () => {
                saveCurrentData();
                currentIndex++;
                
                if (currentIndex < sentences.length) {
                    updateSpotlight();
                } else {
                    enterQuizMode();
                }
            });
        });

        // --- CORE FUNCTIONS ---

        // Jump to sentence (onclick)
        window.jumpTo = (index) => {
            // Only allow jumping if we are still in annotation mode
            if(finalFeedback.classList.contains('active')) return; 
            
            saveCurrentData();
            currentIndex = index;
            updateSpotlight();
        }

        function updateSpotlight() {
            // 1. Visual Highlight
            sentences.forEach((_, i) => {
                const el = document.getElementById(`sent-${i}`);
                if (i === currentIndex) {
                    el.className = 'sentence active';
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    el.className = 'sentence dimmed';
                }
            });

            // 2. UI State
            progressIndicator.textContent = currentIndex + 1;
            btnPrev.disabled = (currentIndex === 0);
            btnNext.textContent = (currentIndex === sentences.length - 1) ? "Finish" : "Next";
            
            // 3. Load Existing Data (if any)
            resetForm();
            if (annotations[currentIndex]) {
                const data = annotations[currentIndex];
                setRating(data.rating, false); // Load rating without clearing diagnosis
                setConfidence(data.confidence, false);
                sentenceFeedback.value = data.feedbackText || '';
                sentenceEntireHard.checked = !!data.entireHard;
            }
            updateNavState();
        }

        function setRating(val, clearDiagnosis = true) {
            effortButtons.forEach(b => {
                b.classList.remove('selected');
                if (parseInt(b.dataset.val) === val) b.classList.add('selected');
            });
            updateNavState();
        }

        function setConfidence(val, clearDiagnosis = true) {
            confidenceButtons.forEach(b => {
                b.classList.remove('selected');
                if (parseInt(b.dataset.val) === val) b.classList.add('selected');
            });
            updateNavState();
        }

        function getSelectedRating() {
            const sel = document.querySelector('#likert-effort .likert-btn.selected');
            return sel ? parseInt(sel.dataset.val) : null;
        }

        function getSelectedConfidence() {
            const sel = document.querySelector('#likert-confidence .likert-btn.selected');
            return sel ? parseInt(sel.dataset.val) : null;
        }

        function updateNavState() {
            const ratingVal = getSelectedRating();
            const confidenceVal = getSelectedConfidence();
            if (ratingVal !== null && confidenceVal !== null) {
                btnNext.classList.add('active');
                btnNext.disabled = false;
            } else {
                btnNext.classList.remove('active');
                btnNext.disabled = true;
            }
        }

        function saveCurrentData() {
            const ratingVal = getSelectedRating();
            const confidenceVal = getSelectedConfidence();
            if (ratingVal === null || confidenceVal === null) return; // Need both

            annotations[currentIndex] = {
                text: sentences[currentIndex],
                rating: ratingVal,
                confidence: confidenceVal,
                feedbackText: sentenceFeedback.value || '',
                entireHard: sentenceEntireHard.checked
            };
        }

        function resetForm() {
            effortButtons.forEach(b => b.classList.remove('selected'));
            confidenceButtons.forEach(b => b.classList.remove('selected'));
            sentenceFeedback.value = '';
            sentenceEntireHard.checked = false;
            btnNext.classList.remove('active');
            btnNext.disabled = true;
        }

        // --- QUIZ MODE ---
        function enterQuizMode() {
            spotlightControls.style.display = 'none';
            finalFeedback.classList.add('active');

            // OPEN BOOK: Remove dimming from all sentences
            document.querySelectorAll('.sentence').forEach(el => {
                el.className = 'sentence'; // Removes .dimmed and .active
                el.style.cursor = 'default';
            });

            // Prepare for quiz-after-overall flow
            quizContainer.style.display = 'none';
            quizContainer.innerHTML = '<p>Please complete the overall feedback, then click "Begin Quiz" to continue.</p>';
            quizCompleteMessage.style.display = 'none';
            startQuizBtn.style.display = 'inline-block';
            overallSection.style.display = 'block';
            startQuizBtn.disabled = true;
            
            // Scroll sidebar to top
            document.querySelector('.sidebar-right').scrollTop = 0;
        }

        // --- QUIZ FLOW ---
        let quizQuestions = [];
        let quizIndex = 0;
        const quizResponses = {}; // idx -> {sentence_id, selected_option, correct_answer, is_correct, question, difficulty, options}
        const quizOptionOrder = {}; // idx -> shuffled array of [key, text]

        // Start quiz only after overall feedback section
        startQuizBtn.addEventListener('click', () => {
            setupQuizFlow();
            quizContainer.style.display = 'block';
            overallSection.style.display = 'none';
            quizCompleteMessage.style.display = 'none';
        });

        function setupQuizFlow() {
            const urlParams = new URLSearchParams(window.location.search);
            const stimulusID = urlParams.get('stimulus') || "text_01";
            quizQuestions = studyQuizzes[stimulusID] || [];
            quizIndex = 0;
            Object.keys(quizOptionOrder).forEach(k => delete quizOptionOrder[k]);

            if (quizQuestions.length === 0) {
                quizContainer.innerHTML = '<p>No questions for this text.</p>';
                return;
            }
            quizCompleteMessage.style.display = 'none';
            document.getElementById('btn-submit-final').style.display = 'none';
            renderCurrentQuizQuestion();
        }

        function renderCurrentQuizQuestion() {
            if (quizQuestions.length === 0) return;
            const q = quizQuestions[quizIndex];
            quizContainer.innerHTML = '';
            quizCompleteMessage.style.display = 'none';

            const block = document.createElement('div');
            block.className = 'quiz-block';

            let html = `<h3 style="margin-top:0;">Step 3. Comprehension Questions</h3>
            <p style="margin:4px 0 12px 0; color:#555;">Answer the question based on the highlighted sentence.</p>`;

            const optionEntries = Object.entries(q.options || {});
            const order = quizOptionOrder[quizIndex] || shuffleOptions(optionEntries);
            quizOptionOrder[quizIndex] = order;
            html += `<label class="quiz-question-text"><strong>Q${quizIndex + 1} of ${quizQuestions.length}. ${q.question}</strong></label>`;

            order.forEach(([key, text]) => {
                const inputName = `quiz_${quizIndex}_ans`;
                html += `
                <div class="form-option">
                    <input type="radio" name="${inputName}" value="${key}">
                    <label>${text}</label>
                </div>`;
            });

            html += `
            <div class="quiz-meta-q">
                <label style="font-weight:bold; font-size:0.9em;">How much effort did answering this question take?</label>
                <div style="display:flex; justify-content:space-between; font-size: 0.8em; margin-top:5px;">
                    <span>Low</span>
                    <span>High</span>
                </div>
                <div style="display:flex; justify-content:space-between; gap:6px;">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="1">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="2">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="3">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="4">
                    <input type="radio" name="quiz_${quizIndex}_effort" value="5">
                </div>

                <label style="font-weight:bold; font-size:0.9em; margin-top:10px; display:block;">How confident are you that you answered it correctly?</label>
                <div style="display:flex; justify-content:space-between; font-size: 0.8em; margin-top:5px;">
                    <span>Not confident</span>
                    <span>Very confident</span>
                </div>
                <div style="display:flex; justify-content:space-between; gap:6px;">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="1">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="2">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="3">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="4">
                    <input type="radio" name="quiz_${quizIndex}_conf" value="5">
                </div>
            </div>
            <div class="nav-bar">
                <button type="button" class="btn-nav btn-prev" id="quiz-prev" ${quizIndex === 0 ? 'disabled' : ''}>Previous</button>
                <button type="button" class="btn-nav btn-next" id="quiz-next">${quizIndex === quizQuestions.length - 1 ? 'Finish' : 'Next'}</button>
            </div>`;

            block.innerHTML = html;
            quizContainer.appendChild(block);

            // Restore saved answers if any
            const saved = quizResponses[quizIndex];
            if (saved) {
                const ansInput = document.querySelector(`input[name="quiz_${quizIndex}_ans"][value="${saved.selected_option}"]`);
                if (ansInput) ansInput.checked = true;
                const effInput = document.querySelector(`input[name="quiz_${quizIndex}_effort"][value="${saved.effort_rating}"]`);
                if (effInput) effInput.checked = true;
                const confInput = document.querySelector(`input[name="quiz_${quizIndex}_conf"][value="${saved.confidence_rating}"]`);
                if (confInput) confInput.checked = true;
            }

            // Highlight the referenced sentence
            highlightQuizSentence(q.sentence_id);

            // Wire buttons
            const quizPrev = document.getElementById('quiz-prev');
            const quizNext = document.getElementById('quiz-next');
            const answerInputs = document.querySelectorAll(`input[name="quiz_${quizIndex}_ans"]`);
            const effortInputs = document.querySelectorAll(`input[name="quiz_${quizIndex}_effort"]`);
            const confInputs = document.querySelectorAll(`input[name="quiz_${quizIndex}_conf"]`);

            const updateNextState = () => {
                const hasAnswer = document.querySelector(`input[name="quiz_${quizIndex}_ans"]:checked`);
                const hasEffort = document.querySelector(`input[name="quiz_${quizIndex}_effort"]:checked`);
                const hasConf = document.querySelector(`input[name="quiz_${quizIndex}_conf"]:checked`);
                if (hasAnswer && hasEffort && hasConf) {
                    quizNext.classList.add('active');
                    quizNext.disabled = false;
                } else {
                    quizNext.classList.remove('active');
                    quizNext.disabled = true;
                }
            };

            answerInputs.forEach(inp => inp.addEventListener('change', updateNextState));
            effortInputs.forEach(inp => inp.addEventListener('change', updateNextState));
            confInputs.forEach(inp => inp.addEventListener('change', updateNextState));
            updateNextState();

            quizPrev.addEventListener('click', () => {
                saveQuizAnswer();
                if (quizIndex > 0) {
                    quizIndex--;
                    renderCurrentQuizQuestion();
                }
            });
            quizNext.addEventListener('click', () => {
                const savedOk = saveQuizAnswer(true);
                if (!savedOk) return;
                if (quizIndex < quizQuestions.length - 1) {
                    quizIndex++;
                    renderCurrentQuizQuestion();
                } else {
                    // End of quiz: keep last question visible, just show submit
                    document.getElementById('btn-submit-final').style.display = 'block';
                    quizNext.disabled = true;
                    quizNext.classList.remove('active');
                }
            });
        }

        function saveQuizAnswer(require = false) {
            const ansInput = document.querySelector(`input[name="quiz_${quizIndex}_ans"]:checked`);
            const effInput = document.querySelector(`input[name="quiz_${quizIndex}_effort"]:checked`);
            const confInput = document.querySelector(`input[name="quiz_${quizIndex}_conf"]:checked`);
            if (require && (!ansInput || !effInput || !confInput)) {
                alert("Please select an answer, effort, and confidence rating before continuing.");
                return false;
            }
            const q = quizQuestions[quizIndex];
            const correctKey = q.correct_answer || Object.keys(q.options || {})[0] || "";
            const selectedVal = ansInput ? ansInput.value : "";
            quizResponses[quizIndex] = {
                sentence_id: q.sentence_id !== undefined ? q.sentence_id : "",
                question: q.question || "",
                selected_option: selectedVal,
                effort_rating: effInput ? effInput.value : "",
                confidence_rating: confInput ? confInput.value : "",
                options: q.options || {},
                correct_answer: correctKey,
                is_correct: selectedVal === correctKey,
                selected_option_text: (q.options || {})[selectedVal] || ""
            };
            return true;
        }

        function highlightQuizSentence(sentenceId) {
            document.querySelectorAll('.sentence').forEach(el => {
                el.classList.remove('active');
                el.classList.add('dimmed');
            });
            if (sentenceId === undefined || sentenceId === null) return;
            const sidStr = String(sentenceId);
            const num = parseInt(sidStr.replace(/\\D/g, ''), 10);
            if (!isNaN(num)) {
                const idx = num - 1;
                const target = document.getElementById(`sent-${idx}`);
                if (target) {
                    target.classList.add('active');
                    target.scrollIntoView({behavior:'smooth', block:'center'});
                }
            }
        }

        function shuffleOptions(arr) {
            const copy = arr.slice();
            for (let i = copy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [copy[i], copy[j]] = [copy[j], copy[i]];
            }
            return copy;
        }

        // --- SUBMIT ---
        document.getElementById('btn-submit-final').addEventListener('click', () => {
            const btn = document.getElementById('btn-submit-final');
            btn.textContent = "Submitting...";
            btn.disabled = true;

            const urlParams = new URLSearchParams(window.location.search);
            const stimulusID = urlParams.get('stimulus') || "text_01";
            
            const finalForm = document.getElementById('final-form');
            const formData = new FormData(finalForm);
            
            // Gather Improvements Checkboxes
            const improvements = [];
            document.querySelectorAll('input[name="improvement"]:checked').forEach(c => improvements.push(c.value));

            // Gather Quiz Answers from sequential flow
            const quizResults = Object.keys(quizResponses).sort((a,b)=>Number(a)-Number(b)).map(idx => quizResponses[idx]);

            // Format Annotations for Google Sheets (Map to Array)
            const annotationArray = Object.keys(annotations).sort().map(k => annotations[k]);

            const topicFam = formData.get('overall_fam') || "N/A";
            const readingFreq = formData.get('overall_freq') || "N/A";
            const overallEffortVal = formData.get('overall_effort') || "N/A";
            const overallConfVal = formData.get('overall_confidence') || "N/A";

            const payload = {
                worker_id: urlParams.get('PROLIFIC_PID') || "TEST_USER",
                study_id: urlParams.get('STUDY_ID') || "TEST_STUDY",       // NEW: Matches Col C in AppScript
                session_id: urlParams.get('SESSION_ID') || "TEST_SESSION", // NEW: Matches Col D in AppScript
                stimulus_id: stimulusID,
                // Pack familiarity + reading frequency together to fit existing App Script field
                familiarity: JSON.stringify({
                    topic_familiarity: topicFam,
                    reading_frequency: readingFreq
                }),
                overall_difficulty: overallEffortVal, // mapped to effort
                confidence: overallConfVal,
                overall_effort: overallEffortVal,
                overall_confidence: overallConfVal,
                improvements: improvements.join(', '),
                annotations: annotationArray,
                quiz_results: quizResults
            };

            fetch(submissionURL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(payload)
            }).then(() => {
                const cc = urlParams.get('cc') || "TEST_CODE";
                window.location.href = "https://app.prolific.com/submissions/complete?cc=" + cc;
            }).catch(err => {
                alert("Error submitting. See console.");
                console.error(err);
                btn.disabled = false;
            });
        });
    </script>
</body>
</html>
